<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Vehicle Dataset Annotation Tool</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 12px 20px; 
            border-radius: 12px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white; 
            padding: 8px 16px; 
            border-radius: 8px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }
        .input-field { 
            padding: 10px 14px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            width: 100%; 
            transition: all 0.2s ease;
            font-size: 14px;
        }
        .input-field:focus { border-color: #667eea; outline: none; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .input-small { padding: 8px 12px; font-size: 12px; }
        .image-container {
            position: relative;
            max-width: 100%;
            max-height: 650px;
            overflow: hidden;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .uploaded-image {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 16px;
            transition: transform 0.2s ease;
        }
        .zoom-controls {
            position: absolute;
            bottom: 16px;
            left: 16px;
            display: flex;
            gap: 8px;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            border-radius: 12px;
        }
        .zoom-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.2s ease;
        }
        .zoom-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        .zoom-level {
            color: white;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            padding: 0 8px;
            min-width: 50px;
            text-align: center;
        }

        .bbox {
            position: absolute;
            border: 3px solid;
            background-color: rgba(0, 0, 0, 0.1);
            cursor: move;
            pointer-events: all;
            border-radius: 4px;
        }
        .bbox.selected {
            border-width: 4px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
            50% { box-shadow: 0 0 25px rgba(255, 255, 255, 1); }
            100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.8); }
        }

        /* Color coding for different annotation types */
        .bbox.vehicle { 
            border-color: #22c55e; 
            background-color: rgba(34, 197, 94, 0.15);
        }
        .bbox.license_plate { 
            border-color: #3b82f6; 
            background-color: rgba(59, 130, 246, 0.15);
        }
        .bbox.wheel { 
            border-color: #f59e0b; 
            background-color: rgba(245, 158, 11, 0.15);
        }

        .bbox.attachment { 
            border-color: #8b5cf6; 
            background-color: rgba(139, 92, 246, 0.15);
        }

        .bbox-label {
            position: absolute;
            top: -30px;
            left: 0;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 10;
        }
        .resize-handle {
            position: absolute;
            background: #fff;
            border: 2px solid #3b82f6;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            cursor: pointer;
            z-index: 15;
        }
        .resize-handle:hover {
            background: #3b82f6;
            transform: scale(1.2);
        }
        .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
        .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
        .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
        .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
        .resize-handle.n { top: -5px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
        .resize-handle.s { bottom: -5px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
        .resize-handle.w { top: 50%; left: -5px; transform: translateY(-50%); cursor: w-resize; }
        .resize-handle.e { top: 50%; right: -5px; transform: translateY(-50%); cursor: e-resize; }

        .bbox.editing {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.6) !important;
        }



        .drop-zone {
            border: 3px dashed #cbd5e1;
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .drop-zone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        .drop-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }
        .section-header {
            font-size: 16px;
            font-weight: bold;
            margin: 20px 0 12px 0;
            padding: 8px 0;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }
        .form-group {
            margin-bottom: 12px;
        }
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 12px;
            color: #374151;
        }
        .checkbox-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px;
            background: #f8fafc;
            border-radius: 6px;
            font-size: 12px;
        }
        .annotation-item {
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }
        .annotation-item:hover {
            background: #e9ecef;
        }
        .annotation-item.selected {
            background: #fff3cd;
            border-color: #ffc107;
        }
        .annotation-info {
            font-size: 11px;
        }
        .annotation-type {
            font-weight: bold;
            font-size: 12px;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 10px;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            background: #f1f5f9;
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }
        .tab {
            flex: 1;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .tab.active {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .scrollable-panel {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-right: 8px;
        }
        .connection-indicator {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #10b981;
            border: 2px solid white;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* Fullscreen mode styles */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-container {
            position: relative;
            width: 95vw;
            height: 95vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .fullscreen-toolbar {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 12px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 12px;
            z-index: 10001;
        }

        .fullscreen-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
            font-size: 12px;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .fullscreen-btn.active {
            background: rgba(255, 215, 0, 0.8);
        }
		
		.scrollable-panel::-webkit-scrollbar {
			width: 10px;
		}
		.scrollable-panel::-webkit-scrollbar-thumb {
			background: rgba(0,0,0,0.2);
			border-radius: 999px;
		}
		.scrollable-panel::-webkit-scrollbar-thumb:hover {
			background: rgba(0,0,0,0.35);
		}

    </style>
</head>
<body>
    <script>
        // Password protection - Change the password below
        const correctPassword = "cute1234";
        const userPassword = prompt("üîê Enter password to access the Vehicle Annotation Tool:");
        
        if (userPassword !== correctPassword) {
            document.body.innerHTML = `
                <div style="display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div style="text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                        <h1 style="color: #dc3545; margin-bottom: 20px;">üö´ Access Denied</h1>
                        <p style="color: #666; margin-bottom: 30px;">Incorrect password. Please contact the administrator for access.</p>
                        <button onclick="location.reload()" style="padding: 12px 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">üîÑ Try Again</button>
                    </div>
                </div>
            `;
            throw new Error("Access denied");
        }
    </script>

    <!-- Your existing div starts here -->  
    <div id="root"></div>
    
    <script type="text/babel">
        const AdvancedVehicleAnnotationTool = () => {
            const [image, setImage] = React.useState(null);
            const [imagePreview, setImagePreview] = React.useState(null);
            const [isDragging, setIsDragging] = React.useState(false);
            const [showMagnifier, setShowMagnifier] = React.useState(false);
            const [magnifierPosition, setMagnifierPosition] = React.useState({ x: 0, y: 0 });
            const [magnifierImagePosition, setMagnifierImagePosition] = React.useState({ x: 0, y: 0 });
            const magnifierSize = 150;
            const magnificationLevel = 2.5;
            const [zoomLevel, setZoomLevel] = React.useState(1);
            const [panPosition, setPanPosition] = React.useState({ x: 0, y: 0 });
            const [isPanning, setIsPanning] = React.useState(false);
            const [lastPanPoint, setLastPanPoint] = React.useState({ x: 0, y: 0 });
            const [magnifierEnabled, setMagnifierEnabled] = React.useState(false);
            const [isFullscreen, setIsFullscreen] = React.useState(false);
            
            // Annotation states
            const [isDrawing, setIsDrawing] = React.useState(false);
            const [drawingStart, setDrawingStart] = React.useState(null);
            const [currentBox, setCurrentBox] = React.useState(null);
            const [selectedAnnotation, setSelectedAnnotation] = React.useState(null);
            const [annotationType, setAnnotationType] = React.useState('vehicle');
            const [wheelType, setWheelType] = React.useState('single');
            const [makeBrand, setMakeBrand] = React.useState('');
            const [activeTab, setActiveTab] = React.useState('basic');
            // Image directory navigation
            const [imageDirectory, setImageDirectory] = React.useState([]);
            const [currentImageIndex, setCurrentImageIndex] = React.useState(0);
            const [selectedDirectory, setSelectedDirectory] = React.useState(null);
            const [saveDirectoryName, setSaveDirectoryName] = React.useState('');
            const [imageAnnotationsMap, setImageAnnotationsMap] = React.useState(() => {
                try {
                    const saved = localStorage.getItem('athy_imageAnnotationsMap');
                    return saved ? JSON.parse(saved) : {};
                } catch (e) {
                    console.warn('Failed to load saved annotations from localStorage:', e);
                    return {};
                }
            });

            // Bbox editing states
            const [isDraggingBox, setIsDraggingBox] = React.useState(false);
            const [isResizingBox, setIsResizingBox] = React.useState(false);
           
            const [resizeHandle, setResizeHandle] = React.useState(null);
            const [initialBoxState, setInitialBoxState] = React.useState(null);
            const [initialMousePos, setInitialMousePos] = React.useState(null);
            const [editingBoxId, setEditingBoxId] = React.useState(null);
            // Undo/Redo functionality
            const [undoHistory, setUndoHistory] = React.useState([]);
            const [redoHistory, setRedoHistory] = React.useState([]);
            const maxHistorySize = 50;
            
            // Complex annotation data
            const [annotations, setAnnotations] = React.useState({
                image: { 
                    filename: "", 
                    width: 1920, 
                    height: 1080, 
                    timestamp: new Date().toISOString() 
                },
                objects: []
            });
            
            // Image properties form data
            const [imagePropertiesForm, setImagePropertiesForm] = React.useState({
                image_type: 'RGB',
				site_location: 'Toll',
                scene: 'day',
                camera_position: 'front',
                is_rain: false
            });

            // Current annotation form data
            const [vehicleForm, setVehicleForm] = React.useState({
                category: 'Car',

                subcategory: '',
                country: 'MY',
                make: '',
                model: '',
                color: '',
                direction: 'Northbound',
                // Mechanical
                number_of_axles_inferred: 2,
                number_of_axles_raised: 0,
                truck_trailer_labels_visible: false,
                cargo_present: false,
                // Attributes
                is_taxi: false,
                is_bus: false,
                bus_type: '',
                is_emergency_vehicle: false,
                is_electric: false,
                // License plate
                license_plate_text: '',
                license_plate_country: 'MY',
                license_plate_format: 'License_Plate_Normal',

                license_plate_blurred: false,
                license_plate_visible: true,
                chainOfThought: []               
            });
            
            // Add new state: image map, label map, and index
			const [imageFiles, setImageFiles] = React.useState([]);        // array<File>

			const [imageByBase, setImageByBase] = React.useState({});      // { baseName: File }
			
			// YOLO TXT labels
			const [yoloFiles, setYoloFiles] = React.useState([]);          // array<File>
			const [yoloByBase, setYoloByBase] = React.useState({});        // { baseName: { text, fileName } }

			const [datasetIndex, setDatasetIndex] = React.useState([]);    // array of rows for UI + navigation
			const [currentBase, setCurrentBase] = React.useState(null);    // which baseName is ‚Äúactive‚Äù
            
            const fileInputRef = React.useRef(null);
            const imageRef = React.useRef(null);
            const containerRef = React.useRef(null);
            const fullscreenContainerRef = React.useRef(null);

            
            // Vehicle categories and subcategories
            const vehicleCategories = {
                'Car': ['Sedan', 'Hatchback', 'Coupe', 'Sports', 'Convertible', 'Other'],
                'SUV': ['SUVs', '4x4 Vehicles', 'Other'],
                'MPV_Small': ['Minivans', 'Compact MPVs', 'Honda Freed', 'Toyota Sienta', 'Perodua Alza', 'Proton Exora', 'Mitsubishi Xpander', 'Toyota Veloz', 'Daihatsu Xenia', 'Perodua Aruz', 'Honda BR-V', 'Chery Tiggo 8 Pro', 'Other'],
                'MPV_Big': ['Toyota Alphard', 'Kia Carnival', 'Hyundai Staria', 'Toyota Vellfire', 'Honda Odyssey', 'Nissan Serena', 'Mazda Biante', 'Mercedes-Benz V-Class', 'Maxus G10', 'Ford Tourneo Custom', 'Lexus LM 350h', 'Other'],
                'Pickup_Truck': ['4x4', 'Light Trucks', 'Other'],
                'Bus': ['School', 'City', 'Coach Buses', 'Other'],
                'Motorcycle': ['Motorbikes', 'Scooters', 'Other'],
                'Vans': ['Passenger & Cargo Vans (large)', 'Other'],
                'Lorry': ['2-Axle (4-Wheel Truck)', 'Other'],
                'Small_Truck': ['2-Axle (6 Wheel) Small trucks', 'Cargo', 'Other'],
                'Medium_Truck': ['3-Axle Medium-sized trucks', 'Other'],
                'Large_Truck': ['4-Axle Larger commercial trucks', 'Other'],
                'Heavy_Truck': ['5+ Axle Heavy-duty trucks', 'Other'],
                'Construction_and_Industrial_vehicle': ['Bulldozer', 'Excavator', 'Crane', 'Forklift', 'Dump truck', 'Mixer', 'Roller', 'Tow trucks', 'Other'],
                'Emergency_Vehicle': ['Bomba', 'Polis', 'Ambulance', 'Other'],
                'Tanker': ['Fuel Tanker', 'Water Tanker', 'Chemical Tanker', 'Food Grade Tanker', 'Other'],
                'Trailer': ['Box Trailer', 'Flatbed Trailer', 'Refrigerated Trailer', 'Car Carrier Trailer', 'Livestock Trailer', 'Other'],
                'Container': ['20ft Container', '40ft Container', 'Refrigerated Container', 'Open Top Container', 'Tank Container', 'Other'],
            };
            
            const directions = ['Northbound', 'Southbound', 'Eastbound', 'Westbound'];
            const colors = ['White', 'Black', 'Silver', 'Gray', 'Red', 'Blue', 'Green', 'Yellow', 'Brown', 'Orange', 'Purple', 'Gold', 'Maroon', 'Other'];
            
            const annotationTypes = [
                { type: 'vehicle', icon: 'üöó', label: 'Vehicle', color: '#22c55e' },
                { type: 'license_plate', icon: 'üî¢', label: 'License Plate', color: '#3b82f6' },
                { type: 'wheel', icon: '‚öôÔ∏è', label: 'Wheel', color: '#f59e0b' },
                { type: 'attachment', icon: 'üöõ', label: 'Attachment', color: '#8b5cf6' },
                { type: 'make', icon: '\u{1F3F7}', label: 'Make', color: '#ec4899' }
            ];          
            const handleImageUpload = (file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            setImage(file);
                            setImagePreview(e.target.result);

                            // Check if we have saved annotations for this image
                            const savedData = imageAnnotationsMap[file.name];
                            if (savedData) {
                                setAnnotations(savedData.annotations);
                                setVehicleForm(savedData.vehicleForm);
                                if (savedData.imagePropertiesForm) {
                                    setImagePropertiesForm(savedData.imagePropertiesForm);
                                }
                                console.log(`üìÇ Restored ${savedData.annotations.objects.length} saved annotations for ${file.name}`);
                            } else {
                            setAnnotations(prev => ({
                                ...prev,
                                image: {
                                    filename: file.name,
                                    width: img.width,
                                    height: img.height,
                                    timestamp: new Date().toISOString()
                                },
                                objects: []
                            }));
                            }
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            const handleDirectoryUpload = (files) => {
              const imgs = Array.from(files).filter(file => file.type.startsWith('image/'));
            
              if (imgs.length === 0) {
                alert('No image files found in the selected directory!');
                return;
              }
            
              setImageFiles(imgs);
              setImageDirectory(imgs);        // keep your existing behaviour if used elsewhere
            
              const imgMap = {};
              for (const f of imgs) {
                imgMap[baseName(f.name)] = f;
              }
              setImageByBase(imgMap);
            
              // Build / refresh index now that images exist
              rebuildDatasetIndex({ nextImageByBase: imgMap });
            
              // Optional: auto-open the first unlabelled item instead of index 0
              const first = pickFirstOpenableBase({ nextImageByBase: imgMap });
              if (first) {
                openByBase(first, { nextImageByBase: imgMap });
              } else {
                // fallback to your existing behaviour
                setCurrentImageIndex(0);
                loadImageAtIndex(imgs, 0);
              }
            };



            const loadImageAtIndex = (files, index) => {
                const file = files[index];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        setImage(file);
                        setImagePreview(e.target.result);
                        
                        // Check if we have saved annotations for this image
                        const savedData = imageAnnotationsMap[file.name];
                        
                        if (savedData) {
                            // Restore saved annotations
                            setAnnotations(savedData.annotations);
                            setVehicleForm(savedData.vehicleForm);
                            if (savedData.imagePropertiesForm) {
                                setImagePropertiesForm(savedData.imagePropertiesForm);
                            }
                            console.log(`üìÇ Restored ${savedData.annotations.objects.length} annotations for ${file.name}`);
                            // alert(`üìÇ Restored ${savedData.annotations.objects.length} saved annotations!`); // Removed popup
                        } else {
                            // No saved data, start fresh
                            setAnnotations({
                                image: {
                                    filename: file.name,
                                    width: img.width,
                                    height: img.height,
                                    timestamp: new Date().toISOString()
                                },
                                objects: []
                            });
                            // Reset form to defaults
                            setVehicleForm({
                                category: 'Car',
                                subcategory: '',
                                country: 'MY',
                                make: '',
                                model: '',
                                color: '',
                                direction: 'Northbound',
                                number_of_axles_inferred: 2,
                                number_of_axles_raised: 0,
                                truck_trailer_labels_visible: false,
                                cargo_present: false,
                                is_taxi: false,
                                is_bus: false,
                                bus_type: '',
                                is_emergency_vehicle: false,
                                is_electric: false,
                                license_plate_text: '',
                                license_plate_country: 'MY',
                                license_plate_format: 'License_Plate_Normal',

                                license_plate_blurred: false,
                                license_plate_visible: true
                            });
                        }
                        
                        setSelectedAnnotation(null);
                        setIsDrawing(false);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };





            const navigateToImage = (direction) => {
                // Save current image annotations before switching
                if (image && annotations.objects.length > 0) {
                    const currentFilename = annotations.image.filename;
                    setImageAnnotationsMap(prev => ({
                        ...prev,
                        [currentFilename]: {
                            annotations: JSON.parse(JSON.stringify(annotations)),
                            vehicleForm: JSON.parse(JSON.stringify(vehicleForm)),
                            imagePropertiesForm: JSON.parse(JSON.stringify(imagePropertiesForm))
                        }
                    }));
                    console.log(`üíæ Saved ${annotations.objects.length} annotations for ${currentFilename}`);
                }

                // Use YOLO-aware navigation when dataset index is available
                const imageRows = datasetIndex.filter((r) => r.hasImage);
                if (imageRows.length > 0) {
                    navigateByIndex(direction);
                    return;
                }

                if (imageDirectory.length === 0) return;

                let newIndex = currentImageIndex;
                if (direction === 'next') {
                    newIndex = (currentImageIndex + 1) % imageDirectory.length;
                } else if (direction === 'prev') {
                    newIndex = currentImageIndex === 0 ? imageDirectory.length - 1 : currentImageIndex - 1;
                }

                setCurrentImageIndex(newIndex);
                loadImageAtIndex(imageDirectory, newIndex);
            };
            
            // helper for Add new state: image map, label map, and index
            const baseName = (filename) => filename.replace(/\.[^/.]+$/, "");
			
			// ------------------------------
			// Dataset index helpers (Images + Labels)
			// ------------------------------
			const rebuildDatasetIndex = ({ nextImageByBase, nextYoloByBase } = {}) => {
				const imgs = nextImageByBase ?? imageByBase;
				const yoloLabels = nextYoloByBase ?? yoloByBase;     // YOLO txt labels

				const bases = new Set([
					...Object.keys(imgs),
					...Object.keys(yoloLabels),
				]);

				const rows = Array.from(bases)
					.sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" }))
					.map((b) => {
						const img = imgs[b] || null;
						const yoloLab = yoloLabels[b] || null;

						const hasYolo = !!yoloLab;

						let status = "image_only";
						if (!img && hasYolo) status = "label_only";
						else if (img && hasYolo) status = "paired_yolo";

						return {
							base: b,
							hasImage: !!img,

							hasYolo,

							imageName: img?.name ?? "",
							yoloLabelName: hasYolo ? (yoloLab.fileName ?? `${b}.txt`) : "",

							status,
						};
					});

				setDatasetIndex(rows);
			};

			
			// ------------------------------
			// YOLO class map (id -> name)
			// ------------------------------
			const YOLO_CLASSES = {
			  0: "class0_emergencyVehicle",
			  1: "class1_lightVehicle",
			  2: "class2_mediumVehicle",
			  3: "class3_heavyVehicle",
			  4: "class4_taxi",
			  5: "class5_bus",
			  6: "class_motocycle",
			  7: "singleWheel",
			  8: "doubleWheel",
			  9: "license_plate",
			  10: "license_plate_taxi",
			};

			const prettyYoloName = (raw) => {
			  if (!raw) return "";
			  return raw
				.replace(/^class\d+_/, "")   // remove "class0_" prefix
				.replace(/_/g, " ")
				.replace(/\b\w/g, (c) => c.toUpperCase());
			};


			const pickFirstOpenableBase = ({ nextImageByBase } = {}) => {
				const imgs = nextImageByBase ?? imageByBase;

				const imgBases = Object.keys(imgs).sort((a, b) =>
					a.localeCompare(b, undefined, { numeric: true, sensitivity: "base" })
				);
				if (imgBases.length === 0) return null;

				// Prefer first image that has no label yet
				const firstUnlabelled = imgBases.find((b) => imgs[b] && !yoloByBase[b]);
				return firstUnlabelled ?? imgBases[0];
			};

			const openByBase = (base, { nextImageByBase, nextYoloByBase } = {}) => {
				const imgs = nextImageByBase ?? imageByBase;
				const yoloLabels = nextYoloByBase ?? yoloByBase;

				const imgFile = imgs[base];
				if (!imgFile) {
					alert(`No image found for base "${base}"`);
					return;
				}

				setCurrentBase(base);

				const yoloLab = yoloLabels[base] || null;

				if (yoloLab) {
					loadImageWithYolo(imgFile, yoloLab);
					return;
				}

				// No labels found
				handleImageUpload(imgFile);
			};


			const navigateByIndex = (direction) => {
				const imageRows = datasetIndex.filter((r) => r.hasImage);
				if (imageRows.length === 0) return;

				const cur = currentBase ?? imageRows[0].base;
				const idx = imageRows.findIndex((r) => r.base === cur);
				const safeIdx = idx >= 0 ? idx : 0;

				const nextIdx =
					direction === "next"
						? (safeIdx + 1) % imageRows.length
						: safeIdx === 0
						? imageRows.length - 1
						: safeIdx - 1;

				openByBase(imageRows[nextIdx].base);
			};


            // Helper function to show temporary messages under the image
            const showTemporaryMessage = (message) => {
                // Create or update message element
                let messageEl = document.getElementById('temp-save-message');
                if (!messageEl) {
                    messageEl = document.createElement('div');
                    messageEl.id = 'temp-save-message';
                    messageEl.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: rgba(0,0,0,0.9);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        font-weight: bold;
                        z-index: 10000;
                        text-align: center;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        max-width: 80%;
                        white-space: pre-line;
                    `;
                    document.body.appendChild(messageEl);
                }
                
                messageEl.textContent = message;
                messageEl.style.display = 'block';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    if (messageEl) {
                        messageEl.style.display = 'none';
                    }
                }, 3000);
            };


            const updateBboxPosition = (id, newBbox) => {
                setAnnotations(prev => ({
                    ...prev,
                    objects: prev.objects.map(obj => 
                        obj.id === id ? { 
                            ...obj, 
                            bbox: [
                                Math.round(newBbox.x),
                                Math.round(newBbox.y),
                                Math.round(newBbox.x + newBbox.width),
                                Math.round(newBbox.y + newBbox.height)
                            ]
                        } : obj
                    )
                }));
            };

            const handleBboxMouseDown = (e, boxId, handle = null) => {
                if (isDrawing && !handle && boxId !== selectedAnnotation) {
                    // If we're in drawing mode, ignore bbox interactions and let drawing happen
                    return;
                }
                e.stopPropagation();
                e.preventDefault();
                
                const mousePos = getImageCoordinates(e);
                const currentBox = annotations.objects.find(obj => obj.id === boxId);
                
                if (!currentBox) return;
                
                // Store initial state for smooth transformations
                setInitialMousePos(mousePos);
                setInitialBoxState({ ...currentBox.bbox });
                setEditingBoxId(boxId);
                setSelectedAnnotation(boxId);
                
                if (handle) {
                    setIsResizingBox(true);
                    setResizeHandle(handle);
                } else {
                    setIsDraggingBox(true);
                }
            };


            const calculateNewBbox = (originalBbox, startMouse, currentMouse, handle) => {
                const deltaX = currentMouse.x - startMouse.x;
                const deltaY = currentMouse.y - startMouse.y;
                
                // Convert array format [x1,y1,x2,y2] to object format {x,y,width,height} for calculations
                const bbox = {
                    x: originalBbox[0],
                    y: originalBbox[1], 
                    width: originalBbox[2] - originalBbox[0],
                    height: originalBbox[3] - originalBbox[1]
                };
                
                let newBbox = { ...bbox };
                
                if (!handle) {
                    // Moving the entire box
                    newBbox.x = Math.max(0, Math.min(bbox.x + deltaX, annotations.image.width - bbox.width));
                    newBbox.y = Math.max(0, Math.min(bbox.y + deltaY, annotations.image.height - bbox.height));
                    return newBbox; // Return as object format for internal use
                }
                
                // Resizing based on handle
                const minSize = 20;
                
                switch (handle) {
                    case 'nw':
                        newBbox.width = Math.max(minSize, bbox.width - deltaX);
                        newBbox.height = Math.max(minSize, bbox.height - deltaY);
                        newBbox.x = bbox.x + (bbox.width - newBbox.width);
                        newBbox.y = bbox.y + (bbox.height - newBbox.height);
                        break;
                    case 'ne':
                        newBbox.width = Math.max(minSize, bbox.width + deltaX);
                        newBbox.height = Math.max(minSize, bbox.height - deltaY);
                        newBbox.y = bbox.y + (bbox.height - newBbox.height);
                        break;
                    case 'sw':
                        newBbox.width = Math.max(minSize, bbox.width - deltaX);
                        newBbox.height = Math.max(minSize, bbox.height + deltaY);
                        newBbox.x = bbox.x + (bbox.width - newBbox.width);
                        break;
                    case 'se':
                        newBbox.width = Math.max(minSize, bbox.width + deltaX);
                        newBbox.height = Math.max(minSize, bbox.height + deltaY);
                        break;
                    case 'n':
                        newBbox.height = Math.max(minSize, bbox.height - deltaY);
                        newBbox.y = bbox.y + (bbox.height - newBbox.height);
                        break;
                    case 's':
                        newBbox.height = Math.max(minSize, bbox.height + deltaY);
                        break;
                    case 'w':
                        newBbox.width = Math.max(minSize, bbox.width - deltaX);
                        newBbox.x = bbox.x + (bbox.width - newBbox.width);
                        break;
                    case 'e':
                        newBbox.width = Math.max(minSize, bbox.width + deltaX);
                        break;
                }
                
                // Ensure bbox stays within image bounds
                newBbox.x = Math.max(0, newBbox.x);
                newBbox.y = Math.max(0, newBbox.y);
                newBbox.width = Math.min(newBbox.width, annotations.image.width - newBbox.x);
                newBbox.height = Math.min(newBbox.height, annotations.image.height - newBbox.y);
                
                return newBbox; // Return as object format for internal use
            };


            const handleDirectorySelect = (e) => {
                const files = e.target.files;
                if (files && files.length > 0) {
                    handleDirectoryUpload(files);
                }
            };
            
            const handleFileSelect = (e) => {
                const file = e.target.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            };

			
			const handleYoloDirectorySelect = async (e) => {
			  const files = e.target.files;
			  if (!files || files.length === 0) return;

			  const txtFiles = Array.from(files).filter(f => f.name.toLowerCase().endsWith(".txt"));
			  if (txtFiles.length === 0) {
				alert("No .txt files found in the selected YOLO labels folder!");
				return;
			  }

			  setYoloFiles(txtFiles);

			  const pairs = await Promise.all(txtFiles.map(async (f) => {
				try {
				  const text = await f.text();
				  const b = baseName(f.name); // e.g. IMG_001.txt -> IMG_001
				  return [b, { text, fileName: f.name }];
				} catch (err) {
				  console.warn("Failed reading YOLO txt:", f.name, err);
				  return null;
				}
			  }));

			  const next = {};
			  for (const p of pairs) {
				if (!p) continue;
				const [b, data] = p;
				next[b] = data;
			  }

			  setYoloByBase(next);

			  // update dataset index (we'll update rebuildDatasetIndex in step 4)
			  rebuildDatasetIndex({ nextYoloByBase: next });
			};

			
			const parseYoloTxtToObjects = (txt, imgW, imgH) => {
			  const lines = (txt || "")
				.split(/\r?\n/)
				.map(l => l.trim())
				.filter(l => l.length > 0);

			  const objects = [];

			  for (let i = 0; i < lines.length; i++) {
				const parts = lines[i].split(/\s+/);
				if (parts.length < 5) continue;

				const classId = Number(parts[0]);
				const xc = Number(parts[1]);
				const yc = Number(parts[2]);
				const w = Number(parts[3]);
				const h = Number(parts[4]);

				if ([classId, xc, yc, w, h].some(v => Number.isNaN(v))) continue;

				const x1 = Math.max(0, Math.round((xc - w / 2) * imgW));
				const y1 = Math.max(0, Math.round((yc - h / 2) * imgH));
				const x2 = Math.min(imgW, Math.round((xc + w / 2) * imgW));
				const y2 = Math.min(imgH, Math.round((yc + h / 2) * imgH));

				const rawName = YOLO_CLASSES[classId] ?? `class_${classId}`;
				const prettyName = prettyYoloName(rawName);

				let type = "vehicle";
				let wheel_type = undefined;

				// Your classes
				if (classId === 9 || classId === 10 || rawName.includes("license_plate")) type = "license_plate";
				if (classId === 7 || rawName.toLowerCase().includes("singlewheel")) { type = "wheel"; wheel_type = "single"; }
				if (classId === 8 || rawName.toLowerCase().includes("doublewheel")) { type = "wheel"; wheel_type = "double"; }

				objects.push({
				  id: `yolo_${Date.now()}_${i}`,
				  type,
				  bbox: [x1, y1, x2, y2],
				  // keep YOLO info for display/debug
				  yolo_class_id: classId,
				  yolo_class_name: prettyName,
				  ...(wheel_type ? { wheel_type } : {}),
				});
			  }

			  return objects;
			};

			const loadImageWithYolo = (imageFile, yoloData) => {
			  const reader = new FileReader();
			  reader.onload = (e) => {
				const img = new Image();
				img.onload = () => {
				  setImage(imageFile);
				  setImagePreview(e.target.result);

				  // Check if we have previously saved annotations for this image
				  const savedData = imageAnnotationsMap[imageFile.name];
				  if (savedData) {
					setAnnotations(savedData.annotations);
					setVehicleForm(savedData.vehicleForm);
					if (savedData.imagePropertiesForm) {
						setImagePropertiesForm(savedData.imagePropertiesForm);
					}
					console.log(`üìÇ Restored ${savedData.annotations.objects.length} saved annotations for ${imageFile.name}`);
					showTemporaryMessage(`üìÇ Restored ${savedData.annotations.objects.length} annotations\n${imageFile.name}`);
				  } else {
					const objs = parseYoloTxtToObjects(yoloData.text, img.width, img.height);
					setAnnotations({
						image: {
						  filename: imageFile.name,
						  width: img.width,
						  height: img.height,
						  timestamp: new Date().toISOString(),
						},
						objects: objs,
					});
					showTemporaryMessage(`‚úÖ Loaded YOLO: ${objs.length} boxes\n${yoloData.fileName}`);
				  }

				  setSelectedAnnotation(null);
				  setIsDrawing(false);
				};
				img.src = e.target.result;
			  };
			  reader.readAsDataURL(imageFile);
			};

			
            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };
            
            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragging(false);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                if (file) {
                    handleImageUpload(file);
                }
            };
            
            const loadExampleImage = () => {
                const exampleImageUrl = "data:image/svg+xml,%3csvg width='1200' height='800' xmlns='http://www.w3.org/2000/svg'%3e%3crect width='100%25' height='100%25' fill='%23f0f9ff'/%3e%3crect x='200' y='300' width='400' height='200' fill='%23ddd' stroke='%23666' stroke-width='3'/%3e%3crect x='580' y='460' width='80' height='30' fill='%23fff' stroke='%23000' stroke-width='2'/%3e%3ctext x='620' y='480' font-size='14' text-anchor='middle' fill='%23000'%3eWXD1023%3c/text%3e%3ccircle cx='250' cy='480' r='25' fill='%23333'/%3e%3ccircle cx='350' cy='480' r='25' fill='%23333'/%3e%3ccircle cx='450' cy='480' r='25' fill='%23333'/%3e%3ccircle cx='550' cy='480' r='25' fill='%23333'/%3e%3ctext x='600' y='200' font-size='36' text-anchor='middle' fill='%23075985'%3eüöõ Heavy Vehicle Example%3c/text%3e%3ctext x='600' y='250' font-size='18' text-anchor='middle' fill='%236b7280'%3ePrime Mover with Trailer%3c/text%3e%3crect x='650' y='320' width='300' height='160' fill='%23eee' stroke='%23666' stroke-width='2'/%3e%3ctext x='800' y='400' font-size='16' text-anchor='middle' fill='%23666'%3eTrailer%3c/text%3e%3c/svg%3e";
                setImagePreview(exampleImageUrl);
                setAnnotations(prev => ({
                    ...prev,
                    image: {
                        filename: "heavy_vehicle_example.jpg",
                        width: 1200,
                        height: 800,
                        timestamp: new Date().toISOString()
                    },
                    objects: []
                }));
            };
            
    
            const handleMouseMove = (e) => {
                if (!imageRef.current) return;
                
                const imageRect = imageRef.current.getBoundingClientRect();
                const mouseX = e.clientX - imageRect.left;
                const mouseY = e.clientY - imageRect.top;
                
                // Check if mouse is over the image
                if (mouseX >= 0 && mouseX <= imageRect.width && mouseY >= 0 && mouseY <= imageRect.height) {
                    setShowMagnifier(true);
                    
                    // Set magnifier position (offset to avoid covering the area being magnified)
                    setMagnifierPosition({
                        x: e.clientX + 20,
                        y: e.clientY - magnifierSize - 20
                    });
                    
                    // Calculate the area of the image to magnify
                    const scaleX = annotations.image.width / imageRect.width;
                    const scaleY = annotations.image.height / imageRect.height;
                    
                    setMagnifierImagePosition({
                        x: mouseX * scaleX,
                        y: mouseY * scaleY
                    });
                } else {
                    setShowMagnifier(false);
                }
            };

            const handleMouseLeave = () => {
                setShowMagnifier(false);
            };

            // Coordinate calculation

            const getImageCoordinates = (e) => {
                if (!imageRef.current) return { x: 0, y: 0 };
                
                const imageRect = imageRef.current.getBoundingClientRect();
                
                // Get mouse position relative to the image element
                const mouseX = e.clientX - imageRect.left;
                const mouseY = e.clientY - imageRect.top;
                
                // Convert to image coordinates (accounting for image scaling)
                const scaleX = annotations.image.width / imageRect.width;
                const scaleY = annotations.image.height / imageRect.height;
                
                const imageX = mouseX * scaleX;
                const imageY = mouseY * scaleY;
                
                // Clamp to image bounds
                return {
                    x: Math.max(0, Math.min(imageX, annotations.image.width)),
                    y: Math.max(0, Math.min(imageY, annotations.image.height))
                };
};
            // Zoom and pan functionality
            const handleZoomIn = () => setZoomLevel(prev => Math.min(prev * 1.2, 5));
            const handleZoomOut = () => setZoomLevel(prev => Math.max(prev / 1.2, 0.1));
            const handleZoomReset = () => { setZoomLevel(1); setPanPosition({ x: 0, y: 0 }); };

            const handleWheel = (e) => {
                if (!imagePreview) return;
                e.preventDefault();
                e.stopPropagation();
                
                // Only zoom the image if Ctrl key is pressed
                if (!e.ctrlKey) return;
                
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newZoomLevel = Math.min(Math.max(zoomLevel * delta, 0.1), 5);
                
                if (newZoomLevel !== zoomLevel) {
                    // Get appropriate container based on current mode
                    const currentContainer = isFullscreen ? fullscreenContainerRef.current : containerRef.current;
                    if (!currentContainer) return;
                    
                    // Get mouse position relative to container for zoom centering
                    const containerRect = currentContainer.getBoundingClientRect();
                    const mouseX = e.clientX - containerRect.left;
                    const mouseY = e.clientY - containerRect.top;
                    
                    // Calculate new pan position to zoom towards mouse
                    const zoomRatio = newZoomLevel / zoomLevel;
                    const newPanX = mouseX - (mouseX - panPosition.x) * zoomRatio;
                    const newPanY = mouseY - (mouseY - panPosition.y) * zoomRatio;
                    
                    setZoomLevel(newZoomLevel);
                    setPanPosition({ x: newPanX, y: newPanY });
                }
            };

                        
            const handleImageMouseDown = (e) => {
                if (!imageRef.current) return;
                
                // Get the appropriate container ref based on current mode
                const currentContainer = isFullscreen ? fullscreenContainerRef.current : containerRef.current;
                if (!currentContainer) return;
                
                // Only start drawing if we're in drawing mode and clicked on empty space

                if (isDrawing) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const coords = getImageCoordinates(e);
                    setDrawingStart(coords);
                    setCurrentBox({
                        x: coords.x,
                        y: coords.y,
                        width: 0,
                        height: 0
                    });

                } else if (!isDrawing && e.target === imageRef.current) {
                    // Allow panning when not drawing
                    setIsPanning(true);
                    setLastPanPoint({ x: e.clientX, y: e.clientY });
                    e.preventDefault();
                }
            };

      
            // Create advanced annotation object
            const createAnnotation = (bbox) => {
                const baseAnnotation = {
                    id: Date.now() + Math.random(),
                    type: annotationType,
                    bbox: [
                        Math.round(bbox.x),
                        Math.round(bbox.y),
                        Math.round(bbox.x + bbox.width),
                        Math.round(bbox.y + bbox.height)
                    ]
                };
                
                if (annotationType === 'vehicle') {
                    return {
                        ...baseAnnotation,
                        direction: vehicleForm.direction,
                        vehicle_info: {
                            category: vehicleForm.category,
                            subcategory: vehicleForm.subcategory,
                            country: vehicleForm.country,
                            make: vehicleForm.make,
                            model: vehicleForm.model,
                            color: vehicleForm.color
                        },
                        mechanical: {
                            number_of_axles_inferred: vehicleForm.number_of_axles_inferred,
                            number_of_axles_raised: vehicleForm.number_of_axles_raised,
                            truck_trailer_labels_visible: vehicleForm.truck_trailer_labels_visible,
                            cargo_present: vehicleForm.cargo_present
                        },
                        attributes: {
                            is_taxi: vehicleForm.is_taxi,
                            is_bus: vehicleForm.is_bus,
                            bus_type: vehicleForm.bus_type,
                            is_emergency_vehicle: vehicleForm.is_emergency_vehicle,
                            is_electric: vehicleForm.is_electric
                        },
                        license_plate: vehicleForm.license_plate_visible ? {
                            bbox: [0, 0, 0, 0], // Will be updated when license plate annotation is added
                            text: vehicleForm.license_plate_text,
                            country: vehicleForm.license_plate_country,
                            format: vehicleForm.license_plate_format,
                            blurred: vehicleForm.license_plate_blurred,
                            visible: vehicleForm.license_plate_visible
                        } : null,
                        wheels: [],
                        axles: [],
                        attachments: [],
                        // ‚úÖ ADD THIS LINE TO ENSURE CoT IS ALWAYS PRESENT:
                        CoT: Array.isArray(vehicleForm.chainOfThought) ? vehicleForm.chainOfThought.filter(line => line.trim() !== '') : []
                    };
                }

                if (annotationType === 'wheel') {
                    return {
                        ...baseAnnotation,
                        type: wheelType === 'double' ? 'doubleWheel' : 'singleWheel',
                        parent_id: null
                    };
                }

                if (annotationType === 'make') {
                    return {
                        ...baseAnnotation,
                        make: makeBrand,
                        parent_id: null
                    };
                }

                return {
                    ...baseAnnotation,
                    parent_id: null,
                    attributes: {}
                };
            };
            // Function to update existing annotation with current form data
            const updateSelectedAnnotationWithForm = () => {
                if (!selectedAnnotation) {
                    alert('Please select an annotation first!');
                    return;
                }
                
                const selectedObj = annotations.objects.find(obj => obj.id === selectedAnnotation);
                if (!selectedObj) {
                    alert('Selected annotation not found!');
                    return;
                }
                
                // Only update if it's a vehicle or make annotation
                if (selectedObj.type !== 'vehicle' && selectedObj.type !== 'make') {
                    alert('üí° This button only updates vehicle and make annotations!\n\nFor other types:\n‚Ä¢ Use keyboard shortcuts (1,2,3,4,5,6)\n‚Ä¢ Or use the type dropdown in "Selected Annotation" section');
                    return;
                }
                
                // Save to history before updating
                saveToHistory(annotations);
                
                // Handle make annotation update
                if (selectedObj.type === 'make') {
                    saveToHistory(annotations);
                    setAnnotations(prev => ({
                        ...prev,
                        objects: prev.objects.map(obj => {
                            if (obj.id === selectedAnnotation) {
                                return { ...obj, make: makeBrand };
                            }
                            return obj;
                        })
                    }));
                    alert('Make annotation updated successfully! üéâ');
                    return;
                }

                // Update the vehicle annotation with form data
                setAnnotations(prev => ({
                    ...prev,
                    objects: prev.objects.map(obj => {
                        if (obj.id === selectedAnnotation) {
                            return {
                                ...obj,
                                direction: vehicleForm.direction,
                                vehicle_info: {
                                    // ‚úÖ ENSURE THE OBJECT EXISTS FIRST:
                                    ...(obj.vehicle_info || {}),
                                    category: vehicleForm.category,
                                    subcategory: vehicleForm.subcategory,
                                    make: vehicleForm.make,
                                    color: vehicleForm.color
                                },
                                mechanical: {
                                    // ‚úÖ ENSURE THE OBJECT EXISTS FIRST:
                                    ...(obj.mechanical || {}),
                                    number_of_axles_inferred: vehicleForm.number_of_axles_inferred,
                                    number_of_axles_raised: vehicleForm.number_of_axles_raised,
                                    truck_trailer_labels_visible: vehicleForm.truck_trailer_labels_visible,
                                    cargo_present: vehicleForm.cargo_present
                                },
                                attributes: {
                                    // ‚úÖ ENSURE THE OBJECT EXISTS FIRST:
                                    ...(obj.attributes || {}),
                                    is_taxi: vehicleForm.is_taxi,
                                    is_bus: vehicleForm.is_bus,
                                    bus_type: vehicleForm.bus_type,
                                    is_emergency_vehicle: vehicleForm.is_emergency_vehicle,
                                    is_electric: vehicleForm.is_electric
                                },
                                license_plate: vehicleForm.license_plate_text ? {
                                    text: vehicleForm.license_plate_text,
                                    country: vehicleForm.license_plate_country,
                                    format: vehicleForm.license_plate_format,
                                    blurred: vehicleForm.license_plate_blurred,
                                    visible: vehicleForm.license_plate_visible
                                } : obj.license_plate,
                                // ‚úÖ ENSURE CoT IS SAVED PROPERLY:
                                CoT: Array.isArray(vehicleForm.chainOfThought) ? vehicleForm.chainOfThought.filter(line => line.trim() !== '') : []
                            };
                        }
                        return obj;
                    })
                }));
                
                alert('Vehicle annotation updated successfully! üéâ');
            };

            const deleteAnnotation = (id) => {
                setAnnotations(prev => ({
                    ...prev,
                    objects: prev.objects.filter(obj => obj.id !== id)
                }));
                setSelectedAnnotation(null);
            };

            // Save state to history for undo functionality
            const saveToHistory = (currentState) => {
                setUndoHistory(prev => {
                    const newHistory = [...prev, JSON.parse(JSON.stringify(currentState))];
                    // Keep only last maxHistorySize states
                    return newHistory.slice(-maxHistorySize);
                });
                setRedoHistory([]); // Clear redo history when new action is performed
            };

            // Undo function
            const undo = () => {
                if (undoHistory.length === 0) return;
                
                const previousState = undoHistory[undoHistory.length - 1];
                const currentState = JSON.parse(JSON.stringify(annotations));
                
                setRedoHistory(prev => [currentState, ...prev.slice(0, maxHistorySize - 1)]);
                setUndoHistory(prev => prev.slice(0, -1));
                setAnnotations(previousState);
                setSelectedAnnotation(null);
            };

            // Handle keyboard shortcuts
            // Auto-save imageAnnotationsMap to localStorage whenever it changes
            React.useEffect(() => {
                try {
                    const data = JSON.stringify(imageAnnotationsMap);
                    localStorage.setItem('athy_imageAnnotationsMap', data);
                    const count = Object.keys(imageAnnotationsMap).filter(
                        k => imageAnnotationsMap[k].annotations.objects.length > 0
                    ).length;
                    if (count > 0) {
                        console.log(`üíæ Auto-saved ${count} annotated images to browser storage`);
                    }
                } catch (e) {
                    console.warn('Failed to save annotations to localStorage:', e);
                }
            }, [imageAnnotationsMap]);

            // Save current working annotations to the map before page unload
            React.useEffect(() => {
                const handleBeforeUnload = () => {
                    if (image && annotations.objects.length > 0) {
                        const currentFilename = annotations.image.filename;
                        const updatedMap = {
                            ...imageAnnotationsMap,
                            [currentFilename]: {
                                annotations: JSON.parse(JSON.stringify(annotations)),
                                vehicleForm: JSON.parse(JSON.stringify(vehicleForm)),
                                imagePropertiesForm: JSON.parse(JSON.stringify(imagePropertiesForm))
                            }
                        };
                        try {
                            localStorage.setItem('athy_imageAnnotationsMap', JSON.stringify(updatedMap));
                            console.log(`üíæ Saved current annotations before page unload`);
                        } catch (e) {
                            console.warn('Failed to save on unload:', e);
                        }
                    }
                };
                window.addEventListener('beforeunload', handleBeforeUnload);
                return () => window.removeEventListener('beforeunload', handleBeforeUnload);
            }, [image, annotations, vehicleForm, imagePropertiesForm, imageAnnotationsMap]);

            // Debounced auto-save of current image annotations (saves every 3 seconds if changes detected)
            React.useEffect(() => {
                if (!image || !annotations.image.filename) return;
                const timer = setTimeout(() => {
                    if (annotations.objects.length > 0) {
                        setImageAnnotationsMap(prev => ({
                            ...prev,
                            [annotations.image.filename]: {
                                annotations: JSON.parse(JSON.stringify(annotations)),
                                vehicleForm: JSON.parse(JSON.stringify(vehicleForm)),
                                imagePropertiesForm: JSON.parse(JSON.stringify(imagePropertiesForm))
                            }
                        }));
                    }
                }, 3000);
                return () => clearTimeout(timer);
            }, [annotations, vehicleForm, imagePropertiesForm]);

            React.useEffect(() => {
                const handleKeyDown = (e) => {
                    // Ignore keyboard shortcuts when user is typing in input fields
                    const activeElement = document.activeElement;
                    const isTyping = activeElement && (
                        activeElement.tagName === 'INPUT' || 
                        activeElement.tagName === 'TEXTAREA' || 
                        activeElement.tagName === 'SELECT' ||
                        activeElement.isContentEditable
                    );
                    
                    // If user is typing, only allow Escape key to work
                    if (isTyping && e.key !== 'Escape') {
                        return;
                    }
                    // Delete selected annotation with Delete or Backspace
                    if ((e.key === 'Delete' || e.key === 'Backspace') && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        deleteAnnotation(selectedAnnotation);
                    }

                    // ADD THESE NEW KEYBOARD SHORTCUTS HERE
                    // Change to vehicle type with '1' key
                    if (e.key === '1' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'vehicle' }
                                    : obj
                            )
                        }));
                    }

                    // Change to license plate with '2' key
                    if (e.key === '2' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'license_plate' }
                                    : obj
                            )
                        }));
                    }

                    // Change to single wheel with '3' key
                    if (e.key === '3' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'wheel', wheel_type: 'single' }
                                    : obj
                            )
                        }));
                    }


                    // Change to double wheel with '4' key
                    if (e.key === '4' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj => 
                                obj.id === selectedAnnotation 
                                    ? { ...obj, type: 'wheel', wheel_type: 'double' }
                                    : obj
                            )
                        }));
                    }
                    // Change to attachment with '4' key
                    if (e.key === '5' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj =>
                                obj.id === selectedAnnotation
                                    ? { ...obj, type: 'attachment' }
                                    : obj
                            )
                        }));
                    }
                    // Change to make with '6' key
                    if (e.key === '6' && selectedAnnotation) {
                        e.preventDefault();
                        saveToHistory(annotations);
                        setAnnotations(prev => ({
                            ...prev,
                            objects: prev.objects.map(obj =>
                                obj.id === selectedAnnotation
                                    ? { ...obj, type: 'make', make: makeBrand }
                                    : obj
                            )
                        }));
                    }

                    // Undo with Ctrl+Z
                    if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                        e.preventDefault();
                        undo();
                    }
                    
                    // Redo with Ctrl+Y or Ctrl+Shift+Z
                    if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
                        e.preventDefault();
                        redo();
                    }
                    
                    // Escape to cancel drawing, deselect, or exit fullscreen
                    if (e.key === 'Escape') {
                        if (isFullscreen) {
                            setIsFullscreen(false);
                        } else if (isDrawing) {
                            setIsDrawing(false);
                            setCurrentBox(null);
                            setDrawingStart(null);
                        } else {
                            setSelectedAnnotation(null);
                        }
                    }

                    // Toggle drawing mode with 'W' key
                    if (e.key === 'w' || e.key === 'W') {
                        e.preventDefault();
                        setIsDrawing(prev => !prev);
                        // Clear any current drawing when toggling
                        setCurrentBox(null);
                        setDrawingStart(null);
                        // Deselect current annotation when entering drawing mode
                        if (!isDrawing) {
                            setSelectedAnnotation(null);
                        }
                    }




                    // Select save directory with 'S' key
                    if ((e.key === 's' || e.key === 'S') && !e.ctrlKey) {
                        e.preventDefault();
                        
                        if ('showDirectoryPicker' in window) {
                            window.showDirectoryPicker()
                                .then(dirHandle => {
                                    // Force state update with callback to ensure it's set
                                    setSelectedDirectory(dirHandle);
                                    setSaveDirectoryName(dirHandle.name);
                                    
                                    // Force a re-render to ensure state is updated
                                    setTimeout(() => {
                                        console.log('‚úÖ Directory set:', dirHandle.name);
                                        showTemporaryMessage(`üìÅ Save location set to: ${dirHandle.name}\nPress 'Ctrl+S' to save images!`);
                                    }, 100);
                                })
                                .catch(error => {
                                    if (error.name !== 'AbortError') {
                                        showTemporaryMessage('‚ö†Ô∏è Directory picker not supported.');
                                    }
                                });
                        } else {
                            showTemporaryMessage('‚ö†Ô∏è Directory picker not supported. Use the button instead!');
                        }
                    }


                    // Save current image with 'Ctrl+S' key  
                    if (e.ctrlKey && (e.key === 's' || e.key === 'S') && !e.shiftKey) {
                        e.preventDefault();
                        
                        console.log('üîç Ctrl+S pressed! selectedDirectory:', selectedDirectory);
                        
                        if (!selectedDirectory) {
                            console.log('‚ùå No directory selected');
                            showTemporaryMessage('‚ö†Ô∏è Please select directory first! Press "S" to choose.');
                            return;
                        }
                        
                        console.log('‚úÖ Directory found, proceeding to save');
                        if (image && annotations.objects.length > 0) {
                            saveCurrentImageToChosenLocation();
                            showTemporaryMessage('‚úÖ Image and JSON saved successfully!');
                        } else if (image && annotations.objects.length === 0) {
                            showTemporaryMessage('‚ö†Ô∏è No annotations to save!');
                        } else {
                            showTemporaryMessage('‚ùå No image loaded!');
                        }
                    }
                    // Save all annotated images with 'Ctrl+Shift+S' key
                    if (e.ctrlKey && e.shiftKey && (e.key === 's' || e.key === 'S')) {
                        e.preventDefault();
                        if (imageDirectory.length > 1 && Object.keys(imageAnnotationsMap).length > 0) {
                            // Trigger the save all function
                            const annotatedImages = Object.keys(imageAnnotationsMap);
                            let savedCount = 0;
                            
                            annotatedImages.forEach(async (filename) => {
                                const imageData = imageAnnotationsMap[filename];
                                if (imageData.annotations.objects.length > 0) {
                                    const baseFilename = filename.split('.')[0];
                                    
                                    const jsonData = {
                                        ...imageData.annotations,
                                        image: {
                                            ...imageData.annotations.image,
                                            ...(imageData.imagePropertiesForm || {})
                                        },
                                        export_info: {
                                            tool: "Advanced Vehicle Dataset Annotation Tool",
                                            version: "2.0",
                                            exported_at: new Date().toISOString(),
                                            schema_version: "AVC-ANPR-v2.0",
                                            batch_export: true
                                        }
                                    };
                                    
                                    await saveJsonToChosenLocation(jsonData, `${baseFilename}.json`);
                                    savedCount++;
                                }
                            });
                            
                            setTimeout(() => {
                                alert(`üéâ Successfully saved ${savedCount} annotated images!`);
                            }, 1000);
                        } else {
                            alert('No annotated images to save!');
                        }
                    }                    
                    // Fullscreen with 'F' key
                    if (e.key === 'f' || e.key === 'F') {
                        e.preventDefault();
                        setIsFullscreen(true);
                    }  
                    // Navigation with arrow keys (only in fullscreen mode with image directory or dataset index)
                    if (isFullscreen && (imageDirectory.length > 1 || datasetIndex.filter(r => r.hasImage).length > 1)) {
                        if (e.key === 'ArrowLeft') {
                            e.preventDefault();
                            navigateToImage('prev');
                        }
                        
                        if (e.key === 'ArrowRight') {
                            e.preventDefault();
                            navigateToImage('next');
                        }
                    }
                                  
                };

                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [selectedAnnotation, annotations, isDrawing, undoHistory, redoHistory, isFullscreen, imageDirectory, currentImageIndex, selectedDirectory, image, datasetIndex, currentBase]);

                        

            // Redo function
            const redo = () => {
                if (redoHistory.length === 0) return;
                
                const nextState = redoHistory[0];
                const currentState = JSON.parse(JSON.stringify(annotations));
                
                setUndoHistory(prev => [...prev, currentState].slice(-maxHistorySize));
                setRedoHistory(prev => prev.slice(1));
                setAnnotations(nextState);
                setSelectedAnnotation(null);
            };
                        
            
            // Export functionality
            const exportAnnotations = () => {
                const exportData = {
                    ...annotations,
                    image: {
                        ...annotations.image,
						image_type: imagePropertiesForm.image_type,
                        site_location: imagePropertiesForm.site_location,
                        scene: imagePropertiesForm.scene,
                        camera_position: imagePropertiesForm.camera_position,
                        is_rain: imagePropertiesForm.is_rain
                    },
                    export_info: {
                        tool: "Advanced Vehicle Dataset Annotation Tool",
                        version: "2.0",
                        exported_at: new Date().toISOString(),
                        schema_version: "AVC-ANPR-v2.0"
                    }
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${annotations.image.filename.split('.')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const saveCurrentImage = () => {
                if (!image || annotations.objects.length === 0) {
                    alert('No annotations to save for current image!');
                    return;
                }
                
                // Save JSON data
                const currentImageData = {
                    ...annotations,
                    image: {
                        ...annotations.image,
						image_type: imagePropertiesForm.image_type,
                        site_location: imagePropertiesForm.site_location,
                        scene: imagePropertiesForm.scene,
                        camera_position: imagePropertiesForm.camera_position,
                        is_rain: imagePropertiesForm.is_rain
                    },
                    export_info: {
                        tool: "Advanced Vehicle Dataset Annotation Tool",
                        version: "4.16",
                        exported_at: new Date().toISOString(),
                        schema_version: "AVC-ANPR-v2.0",
                        image_index: currentImageIndex + 1,
                        total_images: imageDirectory.length
                    }
                };
                
                const blob = new Blob([JSON.stringify(currentImageData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${annotations.image.filename.split('.')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                // Save annotated image with bboxes drawn on it
                saveAnnotatedImage();
            };

            const saveAnnotatedImage = () => {
                if (!imageRef.current) return;
                
                // Create a canvas to draw the image with annotations
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size to match original image
                canvas.width = annotations.image.width;
                canvas.height = annotations.image.height;
                
                // Create a new image to draw on canvas
                const img = new Image();
                img.onload = () => {
                    // Draw the original image first
                    ctx.drawImage(img, 0, 0);
                    
                    // FIXED: Sort annotations by area (largest first) to prevent small boxes being hidden
                    const sortedAnnotations = [...annotations.objects].sort((a, b) => {
                        const areaA = (a.bbox[2] - a.bbox[0]) * (a.bbox[3] - a.bbox[1]);
                        const areaB = (b.bbox[2] - b.bbox[0]) * (b.bbox[3] - b.bbox[1]);
                        return areaB - areaA; // Largest boxes drawn first
                    });
                    
                    // Draw all bounding boxes with proper layering
                    sortedAnnotations.forEach((obj, index) => {
                        const bbox = obj.bbox; // [x1, y1, x2, y2] format
                        
                        // FIXED: Better color system with reduced opacity to prevent hiding
                        const typeColors = {
                            'vehicle': { stroke: '#22c55e', fill: 'rgba(34, 197, 94, 0.08)' },
                            'license_plate': { stroke: '#3b82f6', fill: 'rgba(59, 130, 246, 0.08)' },
                            'wheel': { stroke: '#f59e0b', fill: 'rgba(245, 158, 11, 0.08)' },
                            'attachment': { stroke: '#8b5cf6', fill: 'rgba(139, 92, 246, 0.08)' },
                            'make': { stroke: '#ec4899', fill: 'rgba(236, 72, 153, 0.08)' }
                        };
                        
                        const colors = typeColors[obj.type] || typeColors['vehicle'];
                        
                        // FIXED: Properly convert [x1,y1,x2,y2] to x,y,width,height
                        const x = Math.round(bbox[0]);
                        const y = Math.round(bbox[1]); 
                        const width = Math.round(bbox[2] - bbox[0]);  // x2 - x1
                        const height = Math.round(bbox[3] - bbox[1]); // y2 - y1

                        // Skip invalid boxes
                        if (width <= 0 || height <= 0) {
                            console.warn(`Skipping invalid bbox for ${obj.type}:`, bbox);
                            return;
                        }

                        // FIXED: Draw very light fill so boxes don't hide each other
                        ctx.fillStyle = colors.fill;
                        ctx.fillRect(x, y, width, height);
                        
                        // FIXED: Draw thicker, more visible border
                        ctx.strokeStyle = colors.stroke;
                        ctx.lineWidth = Math.max(4, Math.min(10, Math.sqrt(width * height) / 25));
                        ctx.setLineDash([]);
                        ctx.strokeRect(x, y, width, height);
                        
                        // FIXED: Better label text
                        let labelText = obj.type.replace('_', ' ').toUpperCase();
                        if (obj.type === 'vehicle' && obj.vehicle_info?.category) {
                            labelText = obj.vehicle_info.category.toUpperCase();
                        }
                        if (obj.type === 'wheel' && obj.wheel_type) {
                            labelText = `WHEEL (${obj.wheel_type.toUpperCase()})`;
                        }
                        if (obj.type === 'make' && obj.make) {
                            labelText = `MAKE - ${obj.make}`;
                        }
                        if (obj.license_plate?.text) {
                            labelText += ` - ${obj.license_plate.text}`;
                        }
                        
                        // FIXED: Larger, more visible font
                        const fontSize = Math.max(18, Math.min(32, Math.min(width, height) / 5));
                        ctx.font = `bold ${fontSize}px Arial`;
                        
                        const textMetrics = ctx.measureText(labelText);
                        const textWidth = textMetrics.width;
                        const textHeight = fontSize;
                        
                        // FIXED: Better label positioning that avoids edges
                        let labelX = Math.max(4, Math.min(x, canvas.width - textWidth - 8));
                        let labelY;

                        if (obj.type === 'license_plate') {
                            // License plate label goes below the bbox
                            labelY = y + height + textHeight + 10;
                            // If label goes below canvas, put it inside the box
                            if (labelY > canvas.height - 5) {
                                labelY = y + height - 10;
                            }
                        } else {
                            labelY = y - textHeight - 10;
                            // If label goes above image, put it inside the box
                            if (labelY < textHeight + 5) {
                                labelY = y + textHeight + 10;
                            }
                        }
                        
                        // FIXED: Darker label background for better contrast
                        const padding = 10;
                        ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                        ctx.fillRect(
                            labelX - padding/2, 
                            labelY - textHeight - padding/2, 
                            textWidth + padding, 
                            textHeight + padding
                        );

                        // FIXED: Thicker text outline for maximum visibility
                        ctx.strokeStyle = 'black';
                        ctx.lineWidth = 4;
                        ctx.strokeText(labelText, labelX, labelY - 3);
                        ctx.fillStyle = 'white';
                        ctx.fillText(labelText, labelX, labelY - 3);
                        
                        // FIXED: Better positioned index number
                        if (sortedAnnotations.length > 1) {
                            const indexText = `#${index + 1}`;
                            const indexFontSize = Math.round(fontSize * 0.6);
                            ctx.font = `bold ${indexFontSize}px Arial`;
                            
                            // Position in top-right corner
                            const indexX = x + width - 35;
                            const indexY = y + indexFontSize + 10;
                            
                            // Index background circle
                            ctx.fillStyle = colors.stroke;
                            ctx.beginPath();
                            ctx.arc(indexX + 12, indexY - 5, 12, 0, 2 * Math.PI);
                            ctx.fill();
                            
                            // Index text
                            ctx.fillStyle = 'white';
                            ctx.textAlign = 'center';
                            ctx.fillText(indexText, indexX + 12, indexY);
                            ctx.textAlign = 'left'; // Reset alignment
                        }
                    });
                                        
                    // Save the canvas as image
                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `${annotations.image.filename.split('.')[0]}_annotated.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                };
                
                img.src = imagePreview;
            };



            const exportAllProgress = () => {
                // This could be expanded to save all annotated images' progress
                const progressData = {
                    directory_info: {
                        total_images: imageDirectory.length,
                        current_index: currentImageIndex,
                        exported_at: new Date().toISOString()
                    },
                    current_image: annotations
                };
                
                const blob = new Blob([JSON.stringify(progressData, null, 2)], {
                    type: 'application/json'
                });
                
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `annotation_progress_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            // Modern File System Access API functions
            const saveJsonToChosenLocation = async (data, suggestedName) => {
                try {
                    // Try modern File System Access API first
                    if ('showSaveFilePicker' in window && window.isSecureContext) {
                        try {
                            const fileHandle = await window.showSaveFilePicker({
                                suggestedName: suggestedName,
                                types: [{
                                    description: 'JSON files',
                                    accept: { 'application/json': ['.json'] }
                                }]
                            });
                            
                            const writable = await fileHandle.createWritable();
                            await writable.write(JSON.stringify(data, null, 2));
                            await writable.close();
                            
                            alert('JSON file saved successfully to chosen location!');
                            return true;
                        } catch (pickerError) {
                            // If user cancels or API fails, fall back to download
                            if (pickerError.name === 'AbortError') {
                                return false; // User cancelled
                            }
                            console.log('File picker failed, using download fallback:', pickerError.message);
                        }
                    }
                    
                    // Fallback to download method
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = suggestedName;
                    a.click();
                    URL.revokeObjectURL(url);
                    alert('JSON file downloaded to your Downloads folder!');
                    return true;
                    
                } catch (error) {
                    alert('Error saving file: ' + error.message);
                    return false;
                }
            };


            const saveImageToChosenLocation = async (canvas, suggestedName) => {
                try {
                    // Try modern File System Access API first
                    if ('showSaveFilePicker' in window && window.isSecureContext) {
                        try {
                            const fileHandle = await window.showSaveFilePicker({
                                suggestedName: suggestedName,
                                types: [{
                                    description: 'PNG images',
                                    accept: { 'image/png': ['.png'] }
                                }]
                            });
                            
                            return new Promise((resolve) => {
                                canvas.toBlob(async (blob) => {
                                    try {
                                        const writable = await fileHandle.createWritable();
                                        await writable.write(blob);
                                        await writable.close();
                                        alert('Annotated image saved successfully to chosen location!');
                                        resolve(true);
                                    } catch (error) {
                                        alert('Error writing file: ' + error.message);
                                        resolve(false);
                                    }
                                }, 'image/png');
                            });
                        } catch (pickerError) {
                            // If user cancels or API fails, fall back to download
                            if (pickerError.name === 'AbortError') {
                                return false; // User cancelled
                            }
                            console.log('File picker failed, using download fallback:', pickerError.message);
                        }
                    }
                    
                    // Fallback to download method
                    return new Promise((resolve) => {
                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = suggestedName;
                            a.click();
                            URL.revokeObjectURL(url);
                            alert('Annotated image downloaded to your Downloads folder!');
                            resolve(true);
                        }, 'image/png');
                    });
                    
                } catch (error) {
                    alert('Error saving image: ' + error.message);
                    return false;
                }
            };


            const saveToSelectedDirectory = async (data, filename, isImage = false) => {
                try {
                    if (selectedDirectory && 'showDirectoryPicker' in window) {
                        // Save to selected directory
                        const fileHandle = await selectedDirectory.getFileHandle(filename, { create: true });
                        const writable = await fileHandle.createWritable();
                        
                        if (isImage) {
                            // For images, data is already a blob
                            await writable.write(data);
                        } else {
                            // For JSON
                            await writable.write(JSON.stringify(data, null, 2));
                        }
                        
                        await writable.close();
                        console.log(`‚úÖ Saved ${filename} to ${saveDirectoryName}`);
                        return true;
                    } else {
                        // Fallback to download
                        if (isImage) {
                            const url = URL.createObjectURL(data);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            a.click();
                            URL.revokeObjectURL(url);
                        } else {
                            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                        return true;
                    }
                } catch (error) {
                    console.error('Error saving file:', error);
                    return false;
                }
            };            

            // Helper: draw annotation boxes onto a canvas context
            const drawAnnotationsOnCanvas = (ctx, canvasW, canvasH, objects) => {
                const typeColors = {
                    'vehicle': { stroke: '#22c55e', fill: 'rgba(34, 197, 94, 0.08)' },
                    'license_plate': { stroke: '#3b82f6', fill: 'rgba(59, 130, 246, 0.08)' },
                    'wheel': { stroke: '#f59e0b', fill: 'rgba(245, 158, 11, 0.08)' },
                    'attachment': { stroke: '#8b5cf6', fill: 'rgba(139, 92, 246, 0.08)' },
                    'made': { stroke: '#ec4899', fill: 'rgba(236, 72, 153, 0.08)' }
                };

                const sorted = [...objects].sort((a, b) => {
                    const areaA = (a.bbox[2] - a.bbox[0]) * (a.bbox[3] - a.bbox[1]);
                    const areaB = (b.bbox[2] - b.bbox[0]) * (b.bbox[3] - b.bbox[1]);
                    return areaB - areaA;
                });

                sorted.forEach((obj) => {
                    const bbox = obj.bbox;
                    const colors = typeColors[obj.type] || typeColors['vehicle'];
                    const x = Math.round(bbox[0]);
                    const y = Math.round(bbox[1]);
                    const width = Math.round(bbox[2] - bbox[0]);
                    const height = Math.round(bbox[3] - bbox[1]);
                    if (width <= 0 || height <= 0) return;

                    ctx.fillStyle = colors.fill;
                    ctx.fillRect(x, y, width, height);

                    ctx.strokeStyle = colors.stroke;
                    ctx.lineWidth = Math.max(5, Math.min(8, Math.sqrt(width * height) / 30));
                    ctx.setLineDash([]);
                    ctx.strokeRect(x, y, width, height);

                    let labelText = obj.type.replace('_', ' ').toUpperCase();
                    if (obj.type === 'vehicle' && obj.vehicle_info?.category) labelText = obj.vehicle_info.category.toUpperCase();
                    if (obj.type === 'wheel' && obj.wheel_type) labelText = `WHEEL (${obj.wheel_type.toUpperCase()})`;
                    if (obj.type === 'made' && obj.made) labelText = `MADE - ${obj.made}`;

                    const fontSize = Math.max(18, Math.min(24, Math.min(width, height) / 8));
                    ctx.font = `bold ${fontSize}px Arial`;
                    const textWidth = ctx.measureText(labelText).width;

                    let labelY;
                    if (obj.type === 'license_plate') {
                        labelY = y + height + fontSize + 8;
                        if (labelY > canvasH - 5) labelY = y + height - 8;
                    } else {
                        labelY = y - fontSize - 8;
                        if (labelY < fontSize + 5) labelY = y + fontSize + 8;
                    }

                    ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                    ctx.fillRect(x, labelY - fontSize - 5, textWidth + 12, fontSize + 10);

                    ctx.strokeStyle = 'black';
                    ctx.lineWidth = 3;
                    ctx.strokeText(labelText, x + 6, labelY - 3);
                    ctx.fillStyle = 'white';
                    ctx.fillText(labelText, x + 6, labelY - 3);
                });
            };

            // Helper: generate annotated PNG blob from an image File and annotation objects
            const generateAnnotatedBlob = (imageFile, annotationObjects, imgWidth, imgHeight) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = imgWidth || img.width;
                            canvas.height = imgHeight || img.height;
                            ctx.drawImage(img, 0, 0);
                            drawAnnotationsOnCanvas(ctx, canvas.width, canvas.height, annotationObjects);
                            canvas.toBlob((blob) => resolve(blob), 'image/png');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(imageFile);
                });
            };

            const saveCurrentImageToChosenLocation = async () => {
                if (!image || annotations.objects.length === 0) {
                    alert('No annotations to save for current image!');
                    return;
                }
                
                // CHECK IF DIRECTORY IS SELECTED FIRST
                if (!selectedDirectory) {
                    alert('‚ö†Ô∏è Please select a save directory first using the "üìÅ Select Save Directory" button!');
                    return;
                }
                
                const baseFilename = annotations.image.filename.split('.')[0];
                
                // Save JSON
				const currentImageData = {
					...annotations,
					image: {
						...annotations.image,
						image_type: imagePropertiesForm.image_type,
						site_location: imagePropertiesForm.site_location,
						scene: imagePropertiesForm.scene,
						camera_position: imagePropertiesForm.camera_position,
						is_rain: imagePropertiesForm.is_rain
					},
					export_info: {
						tool: "Advanced Vehicle Dataset Annotation Tool",
						version: "4.16",
						exported_at: new Date().toISOString(),
						schema_version: "AVC-ANPR-v2.0"
					}
				};
                
                const jsonSaved = await saveToSelectedDirectory(currentImageData, `${baseFilename}.json`);
                
                if (jsonSaved) {
                    // Save annotated image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = annotations.image.width;
                    canvas.height = annotations.image.height;
                    
                    const img = new Image();
                    img.onload = async () => {
                        ctx.drawImage(img, 0, 0);
                        
                        // Draw annotations - FIXED VERSION
                        // FIXED: Sort annotations by area (largest first)
                        const sortedAnnotations = [...annotations.objects].sort((a, b) => {
                            const areaA = (a.bbox[2] - a.bbox[0]) * (a.bbox[3] - a.bbox[1]);
                            const areaB = (b.bbox[2] - b.bbox[0]) * (b.bbox[3] - b.bbox[1]);
                            return areaB - areaA;
                        });

                        // Draw annotations with fixed rendering
                        sortedAnnotations.forEach((obj, index) => {
                            const bbox = obj.bbox; // [x1, y1, x2, y2] format
                            
                            // FIXED: Better colors with reduced opacity
                            const typeColors = {
                                'vehicle': { stroke: '#22c55e', fill: 'rgba(34, 197, 94, 0.08)' },
                                'license_plate': { stroke: '#3b82f6', fill: 'rgba(59, 130, 246, 0.08)' },
                                'wheel': { stroke: '#f59e0b', fill: 'rgba(245, 158, 11, 0.08)' },
                                'attachment': { stroke: '#8b5cf6', fill: 'rgba(139, 92, 246, 0.08)' }
                            };
                            
                            const colors = typeColors[obj.type] || typeColors['vehicle'];
                            
                            // FIXED: Convert coordinates properly
                            const x = Math.round(bbox[0]);
                            const y = Math.round(bbox[1]);
                            const width = Math.round(bbox[2] - bbox[0]);  
                            const height = Math.round(bbox[3] - bbox[1]); 
                            
                            if (width <= 0 || height <= 0) return;
                            
                            // FIXED: Very light fill so boxes don't hide each other
                            ctx.fillStyle = colors.fill;
                            ctx.fillRect(x, y, width, height);
                            
                            // FIXED: Thicker, more visible stroke
                            ctx.strokeStyle = colors.stroke;
                            ctx.lineWidth = Math.max(5, Math.min(8, Math.sqrt(width * height) / 30));
                            ctx.setLineDash([]);
                            ctx.strokeRect(x, y, width, height);
                            
                            // FIXED: Better label text
                            let labelText = obj.type.replace('_', ' ').toUpperCase();
                            if (obj.type === 'vehicle' && obj.vehicle_info?.category) {
                                labelText = obj.vehicle_info.category.toUpperCase();
                            }
                            if (obj.type === 'wheel' && obj.wheel_type) {
                                labelText = `WHEEL (${obj.wheel_type.toUpperCase()})`;
                            }
                            if (obj.type === 'make' && obj.make) {
                                labelText = `MAKE - ${obj.make}`;
                            }
                            
                            // FIXED: Larger font
                            const fontSize = Math.max(18, Math.min(24, Math.min(width, height) / 8));
                            ctx.font = `bold ${fontSize}px Arial`;
                            const textWidth = ctx.measureText(labelText).width;
                            
                            // FIXED: Better label positioning
                            let labelY;
                            if (obj.type === 'license_plate') {
                                labelY = y + height + fontSize + 8;
                                if (labelY > canvas.height - 5) labelY = y + height - 8;
                            } else {
                                labelY = y - fontSize - 8;
                                if (labelY < fontSize + 5) labelY = y + fontSize + 8;
                            }
                            
                            // FIXED: Darker label background
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.9)';
                            ctx.fillRect(x, labelY - fontSize - 5, textWidth + 12, fontSize + 10);
                            
                            // FIXED: Text with outline
                            ctx.strokeStyle = 'black';
                            ctx.lineWidth = 3;
                            ctx.strokeText(labelText, x + 6, labelY - 3);
                            ctx.fillStyle = 'white';
                            ctx.fillText(labelText, x + 6, labelY - 3);
                        });
                                                
                        canvas.toBlob(async (blob) => {
                            await saveToSelectedDirectory(blob, `${baseFilename}_annotated.png`, true);
                            console.log(`‚úÖ Saved both JSON and image to ${saveDirectoryName}!`);
                        }, 'image/png');
                    };
                    img.src = imagePreview;
                }
            };

            
            // Mouse event handlers
            React.useEffect(() => {
                const handleGlobalMouseMove = (e) => {
                    if (isPanning) {
                        const deltaX = e.clientX - lastPanPoint.x;
                        const deltaY = e.clientY - lastPanPoint.y;
                        
                        setPanPosition(prev => ({
                            x: prev.x + deltaX,
                            y: prev.y + deltaY
                        }));
                        
                        setLastPanPoint({ x: e.clientX, y: e.clientY });
                    }
                                    
                    if (isDrawing && drawingStart) {
                        const coords = getImageCoordinates(e);
                        const newBox = {
                            x: Math.min(drawingStart.x, coords.x),
                            y: Math.min(drawingStart.y, coords.y),
                            width: Math.abs(coords.x - drawingStart.x),
                            height: Math.abs(coords.y - drawingStart.y)
                        };
                        setCurrentBox(newBox);
                    }
                    
                    // Handle bbox dragging and resizing
                    if ((isDraggingBox || isResizingBox) && editingBoxId && initialBoxState && initialMousePos) {
                        const currentMousePos = getImageCoordinates(e);
                        const newBbox = calculateNewBbox(initialBoxState, initialMousePos, currentMousePos, resizeHandle);
                        updateBboxPosition(editingBoxId, newBbox);
                    }
                };
                
                const handleGlobalMouseUp = () => {
                    if (isPanning) {
                        setIsPanning(false);
                    }                
                 
                    if (isDrawing && drawingStart && currentBox) {
                        if (currentBox.width > 10 && currentBox.height > 10) {
                            // Save current state to history before adding new annotation
                            saveToHistory(annotations);
                            
                            const newAnnotation = createAnnotation(currentBox);
                            setAnnotations(prev => ({
                                ...prev,
                                objects: [...prev.objects, newAnnotation]
                            }));
                            setSelectedAnnotation(newAnnotation.id);
                        }
                        // Clear the drawing states IMMEDIATELY
                        setCurrentBox(null);
                        setDrawingStart(null);
                        // Auto-exit drawing mode after creating annotation
                        setIsDrawing(false);
                    }
                    // Reset bbox editing states
                    if (isDraggingBox || isResizingBox) {
                        setIsDraggingBox(false);
                        setIsResizingBox(false);
                        setEditingBoxId(null);
                        setResizeHandle(null);
                        setInitialBoxState(null);
                        setInitialMousePos(null);
                    }
                };
                
                // Always add event listeners
                document.addEventListener('mousemove', handleGlobalMouseMove);
                document.addEventListener('mouseup', handleGlobalMouseUp);
                
                return () => {
                    document.removeEventListener('mousemove', handleGlobalMouseMove);
                    document.removeEventListener('mouseup', handleGlobalMouseUp);
                };

           
            }, [isDrawing, drawingStart, currentBox, annotationType, vehicleForm, makeBrand, isDraggingBox, isResizingBox, editingBoxId, initialBoxState, initialMousePos, resizeHandle, annotations.objects, isPanning, lastPanPoint]);
            // Force re-render when switching between modes
            React.useEffect(() => {
                // This will trigger a re-render of bboxes when switching modes
                setAnnotations(prev => ({ ...prev }));
            }, [isFullscreen]);



            // Get annotation type icon
            const getAnnotationIcon = (type, wheelType = null) => {
                switch(type) {
                    case 'vehicle': return '1';
                    case 'license_plate': return '2';
                    case 'wheel': return wheelType === 'double' ? '4' : '3';
                    case 'attachment': return '5';
                    case 'make': return '6';
                    default: return 'üì¶';
                }
            };
            
            return (
                <div style={{ minHeight: '100vh', background: 'linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%)' }}>
                    {/* Header */}
                    <div style={{ 
                        background: 'linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #1e3a8a 100%)', 
                        padding: '24px' 
                    }}>
                    <div style={{ maxWidth: '1600px', margin: '0 auto', display: 'flex', alignItems: 'center', gap: '16px' }}>
                        <img 
                            src="./delloyd.jfif" 
                            alt="Delloyd Logo" 
                            style={{
                                width: '80px',
                                height: '80px',
                                objectFit: 'contain'
                            }}
                            onError={(e) => {
                                // Fallback to truck emoji if image fails to load
                                e.target.outerHTML = '<div style="width: 56px; height: 56px; background: rgba(255,255,255,0.2); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px;">üöõ</div>';
                            }}
                        />
                        
                        <div>
                            <h1 style={{ color: 'white', fontSize: '36px', fontWeight: 'bold', margin: 0 }}>
                                Advanced Vehicle Dataset Tool
                            </h1>
                            <p style={{ color: 'rgba(255,255,255,0.8)', fontSize: '16px', margin: '4px 0 0 0' }}>
                                Professional AVC & ANPR Dataset Creation Platform
                            </p>
                        </div>
                    </div>
                    </div>
                    
                    <div style={{ maxWidth: '1600px', margin: '0 auto', padding: '24px', display: 'grid', gridTemplateColumns: '320px 1fr 350px', gap: '24px' }}>
                        {/* Left Panel - Image & Drawing Controls */}
						<div className="card" style={{ padding: '24px' }}>
							<div className="scrollable-panel">

                            <h2 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                üìÅ Image Upload
                            </h2>

                            {/* Compact Upload Section */}
                            <div style={{ marginBottom: '16px' }}>
                                {/* Single Image Upload - Compact */}
                                <div style={{ marginBottom: '8px', padding: '8px', background: '#f8fafc', borderRadius: '6px', border: '1px solid #e2e8f0' }}>
                                    <div style={{ fontSize: '10px', color: '#374151', marginBottom: '4px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                        üì∑ Single Image
                                    </div>
                                    <input 
                                        ref={fileInputRef}
                                        type="file" 
                                        accept="image/*" 
                                        onChange={handleFileSelect}
                                        className="input-field"
                                        style={{ padding: '6px 8px', fontSize: '11px' }}
                                    />
                                </div>


                                {/* Directory Upload - Compact */}
                                <div style={{ marginBottom: '8px', padding: '8px', background: '#f0f9ff', borderRadius: '6px', border: '1px solid #0ea5e9' }}>
                                    <div style={{ fontSize: '10px', color: '#0c4a6e', marginBottom: '4px', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '4px' }}>
                                        üìÅ Folder/Directory
                                    </div>
                                    <div style={{ position: 'relative' }}>
                                        <input 
                                            type="file" 
                                            webkitdirectory="true"
                                            directory="true"
                                            multiple
                                            accept="image/*"
                                            onChange={handleDirectorySelect}
                                            className="input-field"
                                            style={{ opacity: 0, position: 'absolute', zIndex: -1, padding: '6px 8px', fontSize: '11px' }}
                                            id="directory-input"
                                        />
                                        <label 
                                            htmlFor="directory-input"
                                            className="input-field"
                                            style={{ 
                                                display: 'block', 
                                                cursor: 'pointer', 
                                                textAlign: 'center',
                                                backgroundColor: 'white',
                                                border: '2px dashed #0ea5e9',
                                                color: '#0c4a6e',
                                                padding: '6px 8px',
                                                fontSize: '11px'
                                            }}
                                        >
                                            {imageDirectory.length > 0 ? `üìÅ ${imageDirectory.length} images` : 'üìÅ Choose Folder'}
                                        </label>
                                    </div>
                                </div>
                                
								
								{/* YOLO Labels Folder Upload */}
								<div style={{ marginBottom: '8px', padding: '8px', background: '#ecfeff', borderRadius: '6px', border: '1px solid #06b6d4' }}>
								  <div style={{ fontSize: '10px', color: '#0e7490', marginBottom: '4px', fontWeight: 'bold' }}>
									üè∑Ô∏è Labels Folder (YOLO .txt)
								  </div>

								  <div style={{ position: 'relative' }}>
									<input
									  type="file"
									  webkitdirectory="true"
									  directory="true"
									  multiple
									  accept=".txt,text/plain"
									  onChange={handleYoloDirectorySelect}
									  style={{ opacity: 0, position: 'absolute', zIndex: -1 }}
									  id="yolo-directory-input"
									/>
									<label
									  htmlFor="yolo-directory-input"
									  className="input-field"
									  style={{
										display: 'block',
										cursor: 'pointer',
										textAlign: 'center',
										backgroundColor: 'white',
										border: '2px dashed #06b6d4',
										color: '#0e7490',
										padding: '6px 8px',
										fontSize: '11px'
									  }}
									>
									  {yoloFiles.length > 0 ? `üè∑Ô∏è ${yoloFiles.length} TXTs` : 'üè∑Ô∏è Choose YOLO Labels Folder'}
									</label>
								  </div>
								</div>

								
								{/* Dataset Index */}
								<div style={{ marginTop: '12px', padding: '10px', background: '#f8fafc', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
									<div style={{ fontSize: '11px', fontWeight: 'bold', marginBottom: '8px', color: '#111827' }}>
										üóÇÔ∏è Dataset Index
									</div>

									<div style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
										<button className="btn-secondary" onClick={() => rebuildDatasetIndex()} style={{ flex: 1 }}>
											üîÑ Rebuild
										</button>
										<button className="btn-secondary" onClick={() => currentBase ? openByBase(currentBase) : null} style={{ flex: 1 }}>
											‚ñ∂Ô∏è Open Current
										</button>
									</div>

									<div style={{ display: 'flex', gap: '8px', marginBottom: '8px' }}>
										<button className="btn-secondary" onClick={() => navigateByIndex('prev')} style={{ flex: 1 }}>
											‚¨ÖÔ∏è Prev
										</button>
										<button className="btn-secondary" onClick={() => navigateByIndex('next')} style={{ flex: 1 }}>
											Next ‚û°Ô∏è
										</button>
									</div>

									<div style={{ fontSize: '10px', color: '#374151', marginBottom: '8px' }}>
										Images: <b>{Object.keys(imageByBase).length}</b>
										{" | "}YOLO: <b>{Object.keys(yoloByBase).length}</b>
										{" | "}Paired(YOLO): <b>{datasetIndex.filter(r => r.status === 'paired_yolo').length}</b>

									</div>

									<div className="scrollable-panel" style={{ maxHeight: '220px', paddingRight: '6px' }}>
										{datasetIndex.length === 0 ? (
											<div style={{ fontSize: '11px', color: '#6b7280' }}>Load folders to build the index.</div>
										) : (
											datasetIndex.filter(r => r.hasImage).map((row) => (
												<div
													key={row.base}
													onClick={() => openByBase(row.base)}
													style={{
													padding: '8px',
														borderRadius: '8px',
														border: '1px solid #e5e7eb',
														background: row.base === currentBase ? '#fff7ed' : 'white',
														cursor: 'pointer',
														marginBottom: '6px'
													}}
												>
													<div style={{ fontSize: '11px', fontWeight: 'bold' }}>
														{row.status === 'paired_yolo' ? '‚úÖY' : 'üü°'}
													</div>
													<div style={{ fontSize: '10px', color: '#6b7280' }}>
														{row.imageName}
														{row.hasYolo ? ` ‚Ä¢ ${row.yoloLabelName}` : ''}
														{!row.hasYolo ? ' ‚Ä¢ (no label)' : ''}

													</div>
												</div>
											))
										)}
									</div>
								</div>



                            </div>

                            {/* Chain of Thought (CoT) Section - Now in Left Panel */}
                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '14px', fontWeight: 'bold', marginBottom: '8px', display: 'flex', alignItems: 'center', gap: '6px', color: '#374151' }}>
                                    üß† Chain of Thought (CoT)
                                    <button 
                                        onClick={() => alert(`üìù CoT Examples:\n\n"Volvo prime mover detected pulling a box-type trailer."\n"Main vehicle plate WXD1023 and trailer plate TRL9087 are both visible."\n"Total of 10 wheels seen; one axle appears lifted."\n"Trailer is loaded (cargo flag = true)."\n"No bus, taxi, or emergency markings detected."\n\nüí° Each line will be saved separately in the JSON!`)}
                                        style={{
                                            background: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '50%',
                                            width: '20px',
                                            height: '20px',
                                            fontSize: '12px',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            fontWeight: 'bold'
                                        }}
                                        title="Click for CoT examples"
                                    >
                                        !
                                    </button>
                                </div>
                                <div style={{ 
                                    background: '#f8f9fa', 
                                    border: '1px solid #e9ecef', 
                                    borderRadius: '8px',
                                    padding: '10px'
                                }}>
                                    <textarea 
                                        className="input-field"
                                        placeholder="Write your reasoning, observations, or notes... (Press Enter for new lines)"
                                        value={Array.isArray(vehicleForm.chainOfThought) ? vehicleForm.chainOfThought.join('\n') : (vehicleForm.chainOfThought || '')}
                                        onChange={(e) => {
                                            // Simply split by newlines and save as array
                                            const lines = e.target.value.split('\n');
                                            setVehicleForm(prev => ({ 
                                                ...prev, 
                                                chainOfThought: lines
                                            }));
                                        }}
                                        style={{ 
                                            minHeight: '120px',
                                            resize: 'vertical',
                                            fontSize: '11px',
                                            fontFamily: 'inherit',
                                            padding: '8px'
                                        }}
                                    />
                                    
                                    {/* Add Reasoning Button */}
                                    <button 
                                        onClick={() => {
                                            const currentLines = Array.isArray(vehicleForm.chainOfThought) ? vehicleForm.chainOfThought : [];
                                            
                                            // Add a new empty line for user to type
                                            setVehicleForm(prev => ({ 
                                                ...prev, 
                                                chainOfThought: [...currentLines, ""]
                                            }));
                                            
                                            // Focus the textarea after adding
                                            setTimeout(() => {
                                                const textarea = document.querySelector('textarea[placeholder*="Write your reasoning"]');
                                                if (textarea) {
                                                    textarea.focus();
                                                    textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                                                }
                                            }, 50);
                                        }}
                                        style={{
                                            background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '6px',
                                            padding: '6px 12px',
                                            fontSize: '10px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            marginTop: '6px',
                                            width: '100%'
                                        }}
                                    >
                                        ‚ûï Add Reasoning Line
                                    </button>
                                    
                                    <div style={{ 
                                        fontSize: '9px', 
                                        color: '#6b7280', 
                                        marginTop: '4px',
                                        fontStyle: 'italic' 
                                    }}>
                                        üí° Press Enter for new lines, each line saves separately to JSON.
                                    </div>
                                </div>
                            </div>

                            {/* Example Button - Compact */}
                            <button 
                                onClick={loadExampleImage}
                                className="btn-primary" 
                                style={{ width: '100%', padding: '8px 12px', fontSize: '11px', marginBottom: '12px' }}
                            >
                                ‚ö° Example Vehicle
                            </button>                                                        

                            {image && (
                                <div style={{ marginBottom: '20px', padding: '12px', background: '#f0f9ff', borderRadius: '8px', border: '2px solid #0ea5e9' }}>
                                    <div style={{ fontSize: '12px', color: '#0c4a6e', fontWeight: 'bold', marginBottom: '6px' }}>
                                        üì∏ Image Information
                                    </div>
                                    <div style={{ fontSize: '11px', color: '#075985' }}>
                                        <div><strong>File:</strong> {annotations.image.filename}</div>
                                        <div><strong>Resolution:</strong> {annotations.image.width} √ó {annotations.image.height}px</div>
                                        {imageDirectory.length > 1 && (
                                            <>
                                                <div><strong>Progress:</strong> {currentImageIndex + 1} of {imageDirectory.length}</div>
                                                <div style={{ color: '#8b5cf6', fontWeight: 'bold' }}>
                                                    <strong>üìÅ Total Annotated:</strong> {Object.keys(imageAnnotationsMap).filter(filename => imageAnnotationsMap[filename].annotations.objects.length > 0).length} images
                                                </div>
                                            </>
                                        )}
                                        <div><strong>Current Annotations:</strong> {annotations.objects.length}</div>
                                        {imageAnnotationsMap[annotations.image.filename] && (
                                            <div style={{ color: '#10b981', fontWeight: 'bold' }}>
                                                üíæ {imageAnnotationsMap[annotations.image.filename].annotations.objects.length} saved annotations
                                            </div>
                                        )}
                                        <div style={{ color: '#6366f1', fontWeight: 'bold', marginTop: '4px' }}>
                                            üóÑÔ∏è Browser storage: {Object.keys(imageAnnotationsMap).filter(k => imageAnnotationsMap[k].annotations.objects.length > 0).length} images saved
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', gap: '4px', marginTop: '8px' }}>
                                        <button
                                            onClick={() => {
                                                if (image && annotations.objects.length > 0) {
                                                    const currentFilename = annotations.image.filename;
                                                    setImageAnnotationsMap(prev => ({
                                                        ...prev,
                                                        [currentFilename]: {
                                                            annotations: JSON.parse(JSON.stringify(annotations)),
                                                            vehicleForm: JSON.parse(JSON.stringify(vehicleForm)),
                                                            imagePropertiesForm: JSON.parse(JSON.stringify(imagePropertiesForm))
                                                        }
                                                    }));
                                                    showTemporaryMessage(`üíæ Saved annotations for ${currentFilename}`);
                                                }
                                            }}
                                            style={{
                                                flex: 1,
                                                background: '#10b981',
                                                color: 'white',
                                                border: 'none',
                                                padding: '6px 8px',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '10px',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                            üíæ Save Current
                                        </button>
                                        <button
                                            onClick={() => {
                                                if (confirm('Clear all saved annotations from browser storage? This cannot be undone.')) {
                                                    localStorage.removeItem('athy_imageAnnotationsMap');
                                                    setImageAnnotationsMap({});
                                                    showTemporaryMessage('üóëÔ∏è Cleared all saved annotations from browser storage');
                                                }
                                            }}
                                            style={{
                                                flex: 1,
                                                background: '#ef4444',
                                                color: 'white',
                                                border: 'none',
                                                padding: '6px 8px',
                                                borderRadius: '6px',
                                                cursor: 'pointer',
                                                fontSize: '10px',
                                                fontWeight: 'bold'
                                            }}
                                        >
                                            üóëÔ∏è Clear Storage
                                        </button>
                                    </div>
                                </div>
                            )}
                            
                            <div className="section-header">
                                üéØ Annotation Controls
                            </div>
                            
                            <div className="form-group">
                                <label className="form-label">Annotation Type</label>
                                <select 
                                    className="input-field input-small"
                                    value={annotationType}
                                    onChange={(e) => setAnnotationType(e.target.value)}
                                >
                                    <option value="vehicle">üöó Vehicle</option>
                                    <option value="license_plate">üî¢ License Plate</option>
                                    <option value="wheel">‚öôÔ∏è Wheel</option>
                                    <option value="attachment">üöõ Attachment/Trailer</option>
                                    <option value="make">üè∑Ô∏è Make (Logo/Brand)</option>
                                </select>
                            </div>

                            {/* Wheel Type Selector - only show when wheel is selected */}
                            {annotationType === 'wheel' && (
                                <div className="form-group">
                                    <label className="form-label">Wheel Type</label>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button 
                                            className={`btn-secondary ${wheelType === 'single' ? 'active' : ''}`}
                                            style={{ 
                                                flex: 1,
                                                background: wheelType === 'single' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
                                                fontSize: '11px',
                                                padding: '6px 12px'
                                            }}
                                            onClick={() => setWheelType('single')}
                                        >
                                            üîò Single Wheel
                                        </button>
                                        <button 
                                            className={`btn-secondary ${wheelType === 'double' ? 'active' : ''}`}
                                            style={{ 
                                                flex: 1,
                                                background: wheelType === 'double' ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
                                                fontSize: '11px',
                                                padding: '6px 12px'
                                            }}
                                            onClick={() => setWheelType('double')}
                                        >
                                            ‚ö´‚ö´ Double Wheel
                                        </button>
                                    </div>
                                </div>
                            )}

                            {/* Make Input - only show when make is selected */}
                            {annotationType === 'make' && (
                                <div className="form-group">
                                    <label className="form-label">Make</label>
                                    <input
                                        className="input-field input-small"
                                        placeholder="e.g. Toyota, Mercedes, Volvo"
                                        value={makeBrand}
                                        onChange={(e) => setMakeBrand(e.target.value)}
                                    />
                                </div>
                            )}

                            <div style={{ marginBottom: '20px' }}>
                                <button
                                    className="btn-primary"
                                    style={{ 
                                        width: '100%', 
                                        marginBottom: '10px',
                                        background: isDrawing ? 'linear-gradient(135deg, #ff6b00 0%, #ff8f00 100%)' : 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)'
                                    }}
                                    onClick={() => setIsDrawing(!isDrawing)}
                                    disabled={!imagePreview}
                                >
                                    {isDrawing ? 'üéØ Drawing Mode ON (Press W to exit)' : '‚úèÔ∏è Start Drawing (Press W)'}
                                </button>
                                
                                {annotations.objects.length > 0 && (
                                    <button 
                                        onClick={() => {
                                            saveToHistory(annotations);
                                            setAnnotations(prev => ({ ...prev, objects: [] }));
                                            setSelectedAnnotation(null);
                                        }}
                                        style={{ 
                                            width: '100%', 
                                            padding: '10px', 
                                            background: 'linear-gradient(135deg, #ff4757 0%, #ff3838 100%)', 
                                            color: 'white', 
                                            border: 'none', 
                                            borderRadius: '8px', 
                                            fontWeight: 'bold', 
                                            cursor: 'pointer',
                                            fontSize: '12px'
                                        }}
                                    >
                                        üóëÔ∏è Clear All Annotations
                                    </button>
                                )}
                            </div>
                            
                            {/* Annotations List */}
                            {annotations.objects.length > 0 && (
                                <div>
                                    <div className="section-header">
                                        üìã Annotations ({annotations.objects.length})
                                    </div>
                                    <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                        {annotations.objects.map((obj, index) => (
                                            <div 
                                                key={obj.id}
                                                className={`annotation-item ${selectedAnnotation === obj.id ? 'selected' : ''}`}
                                                onClick={() => {
                                                    setSelectedAnnotation(obj.id);
                                                    // Auto-load vehicle form when selecting a vehicle annotation
                                                    if (obj.type === 'vehicle') {
                                                        setVehicleForm({
                                                            category: obj.vehicle_info?.category || 'Car',
                                                            subcategory: obj.vehicle_info?.subcategory || '',
                                                            country: obj.vehicle_info?.country || 'MY',
                                                            make: obj.vehicle_info?.make || '',
                                                            model: obj.vehicle_info?.model || '',
                                                            color: obj.vehicle_info?.color || '',
                                                            direction: obj.direction || 'Northbound',
                                                            number_of_axles_inferred: obj.mechanical?.number_of_axles_inferred || 2,
                                                            number_of_axles_raised: obj.mechanical?.number_of_axles_raised || 0,
                                                            truck_trailer_labels_visible: obj.mechanical?.truck_trailer_labels_visible || false,
                                                            cargo_present: obj.mechanical?.cargo_present || false,
                                                            is_taxi: obj.attributes?.is_taxi || false,
                                                            is_bus: obj.attributes?.is_bus || false,
                                                            bus_type: obj.attributes?.bus_type || '',
                                                            is_emergency_vehicle: obj.attributes?.is_emergency_vehicle || false,
                                                            is_electric: obj.attributes?.is_electric || false,
                                                            license_plate_text: obj.license_plate?.text || '',
                                                            license_plate_country: obj.license_plate?.country || 'MY',
                                                            license_plate_format: obj.license_plate?.format || 'License_Plate_Normal',
                                                            license_plate_blurred: obj.license_plate?.blurred || false,
                                                            license_plate_visible: obj.license_plate?.visible !== false,
                                                            // ‚úÖ FIX THIS LINE TOO:
                                                            chainOfThought: Array.isArray(obj.CoT) ? obj.CoT : []
                                                        });
                                                    }
                                                    if (obj.type === 'make') {
                                                        setMakeBrand(obj.make || '');
                                                        setAnnotationType('make');
                                                    }
                                                }}                                            
                                            >
                                                <div>  
                                                    <div className="annotation-type">
                                                        {getAnnotationIcon(obj.type, obj.wheel_type)} {obj.type === 'make' ? (obj.make ? `MAKE - ${obj.make}` : 'MAKE') : obj.type.replace('_', ' ').toUpperCase()}
                                                        {obj.type === 'wheel' && obj.wheel_type && ` (${obj.wheel_type.toUpperCase()})`}
                                                        {obj.type === 'wheel' && obj.wheel_type && (
                                                            <span style={{ fontSize: '10px', color: '#6c757d', marginLeft: '4px' }}>
                                                                ({obj.wheel_type.toUpperCase()})
                                                            </span>
                                                        )}
                                                    </div>
                                                    <div className="annotation-info" style={{ color: '#6c757d' }}>
                                                        {Math.round(obj.bbox[2] - obj.bbox[0])}√ó{Math.round(obj.bbox[3] - obj.bbox[1])}px
                                                        {obj.license_plate?.text && (
                                                            <span> ‚Ä¢ {obj.license_plate.text}</span>
                                                        )}
                                                    </div>
                                                </div>
                                                <button
                                                    className="delete-btn"
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        saveToHistory(annotations);
                                                        deleteAnnotation(obj.id);
                                                    }}
                                                >
                                                    ‚úï
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            

                            {/* Export Controls */}
                            {annotations.objects.length > 0 && (
                                <div style={{ marginTop: '20px' }}>
                                    <div className="section-header">
                                        üíæ Save & Export
                                    </div>
                                    {/* Select directory for saving */}
                                    <button 
                                        onClick={async () => {
                                            try {
                                                if ('showDirectoryPicker' in window) {
                                                    const dirHandle = await window.showDirectoryPicker();
                                                    setSelectedDirectory(dirHandle);
                                                    setSaveDirectoryName(dirHandle.name);
                                                    alert(`üìÅ Save location set to: ${dirHandle.name}`);
                                                } else {
                                                    alert('‚ö†Ô∏è Directory picker not supported. Files will download to default folder.');
                                                }
                                            } catch (error) {
                                                if (error.name !== 'AbortError') {
                                                    console.error('Error selecting directory:', error);
                                                }
                                            }
                                        }}
                                        className="btn-secondary"
                                        style={{ 
                                            width: '100%', 
                                            marginBottom: '8px',
                                            background: selectedDirectory ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                                            border: selectedDirectory ? 'none' : '2px solid #ef4444',
                                            animation: selectedDirectory ? 'none' : 'pulse 2s infinite'
                                        }}
                                    >
                                        {selectedDirectory ? `üìÅ Save to: ${saveDirectoryName}` : 'üìÅ Select Save Directory (Press S)'}
                                    </button>                                    

                                    <button 
                                        onClick={saveCurrentImageToChosenLocation}
                                        className="btn-primary"
                                        style={{ 
                                            width: '100%', 
                                            marginBottom: '8px',
                                            background: 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)'
                                        }}
                                    >
                                        üíæ Save JSON + Annotated Image (Ctrl + S)
                                    </button>

                                    {/* Save all annotated images at once */}
                                    {imageDirectory.length > 1 && Object.keys(imageAnnotationsMap).length > 0 && (
                                        <button
                                            onClick={async () => {
                                                if (!selectedDirectory) {
                                                    alert('‚ö†Ô∏è Please select a save directory first!');
                                                    return;
                                                }

                                                const annotatedImages = Object.keys(imageAnnotationsMap);
                                                let savedCount = 0;
                                                const total = annotatedImages.filter(f => imageAnnotationsMap[f].annotations.objects.length > 0).length;

                                                showTemporaryMessage(`‚è≥ Saving ${total} annotated images (JSON + PNG)...`);

                                                for (const filename of annotatedImages) {
                                                    const imageData = imageAnnotationsMap[filename];
                                                    if (imageData.annotations.objects.length > 0) {
                                                        const baseFilename = filename.split('.')[0];

                                                        // Save JSON
                                                        const jsonData = {
                                                            ...imageData.annotations,
                                                            image: {
                                                                ...imageData.annotations.image,
                                                                ...(imageData.imagePropertiesForm || {})
                                                            },
                                                            export_info: {
                                                                tool: "Advanced Vehicle Dataset Annotation Tool",
                                                                version: "4.16",
                                                                exported_at: new Date().toISOString(),
                                                                schema_version: "AVC-ANPR-v2.0",
                                                                batch_export: true
                                                            }
                                                        };

                                                        await saveToSelectedDirectory(jsonData, `${baseFilename}.json`);

                                                        // Save annotated PNG ‚Äî find the image File
                                                        const imgFile = imageDirectory.find(f => f.name === filename)
                                                            || imageByBase[baseFilename]
                                                            || null;

                                                        if (imgFile) {
                                                            const blob = await generateAnnotatedBlob(
                                                                imgFile,
                                                                imageData.annotations.objects,
                                                                imageData.annotations.image.width,
                                                                imageData.annotations.image.height
                                                            );
                                                            if (blob) {
                                                                await saveToSelectedDirectory(blob, `${baseFilename}_annotated.png`, true);
                                                            }
                                                        }

                                                        savedCount++;
                                                        showTemporaryMessage(`‚è≥ Saving... ${savedCount} / ${total}`);
                                                    }
                                                }

                                                showTemporaryMessage(`üéâ Saved ${savedCount} images (JSON + PNG) to ${saveDirectoryName}!`);
                                            }}
                                            className="btn-primary"
                                            style={{
                                                width: '100%',
                                                marginBottom: '8px',
                                                background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)'
                                            }}
                                        >
                                            üíæ Save All JSON + Annotated Images ({Object.keys(imageAnnotationsMap).filter(filename => imageAnnotationsMap[filename].annotations.objects.length > 0).length})
                                        </button>
                                    )}




                                    
                                    <div style={{ fontSize: '10px', color: '#6b7280', marginTop: '8px', fontStyle: 'italic' }}>
                                        üí° Tip: Create "annotated_images" and "JSON" folders to organize your exports!
                                    </div>
                                </div>
                            )}
							</div> {/* end scrollable-panel */}
						</div>   {/* end left card */}

                        
                        {/* Main Canvas */}
                        <div className="card" style={{ padding: '24px', minHeight: '650px', display: 'flex', flexDirection: 'column' }}>
                            {!imagePreview ? (
                                <div
                                    className={`drop-zone ${isDragging ? 'dragover' : ''}`}
                                    onDragOver={handleDragOver}
                                    onDragLeave={handleDragLeave}
                                    onDrop={handleDrop}
                                    onClick={() => fileInputRef.current?.click()}
                                    style={{ height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', flex: 1 }}
                                >
                                    <div style={{ fontSize: '48px', marginBottom: '12px' }}>üñºÔ∏è</div>
                                    <h3 style={{ fontSize: '20px', color: '#64748b', marginBottom: '6px' }}>
                                        {isDragging ? 'Drop your vehicle images here!' : 'Upload images for annotation'}
                                    </h3>
                                    <p style={{ color: '#94a3b8', fontSize: '13px', margin: 0 }}>Single image or entire folder</p>
                                    <p style={{ color: '#cbd5e1', fontSize: '12px', margin: '8px 0 0 0' }}>
                                        Supported formats: JPG, PNG, GIF, WebP
                                    </p>
                                </div>
                            ) : (
                               
                                <div 
                                    ref={containerRef}
                                    className="image-container"
                                    onMouseMove={handleMouseMove}
                                    onMouseLeave={handleMouseLeave}
                                    onWheel={handleWheel}
                                    style={{ 
                                        position: 'relative',
                                        maxWidth: '100%',
                                        maxHeight: '650px',
                                        overflow: 'hidden',
                                        borderRadius: '16px',
                                        boxShadow: '0 10px 25px rgba(0,0,0,0.1)',
                                        cursor: isDrawing ? 'crosshair' : (zoomLevel > 1 ? (isPanning ? 'grabbing' : 'grab') : 'default')

                                    }}
                                    onMouseDown={handleImageMouseDown}
                                >
                                

                                    <img 
                                        ref={imageRef}
                                        key={`normal-${isFullscreen}`}
                                        src={imagePreview} 
                                        alt="Vehicle for annotation" 
                                        className="uploaded-image"
                                        style={{
                                            transform: `scale(${zoomLevel}) translate(${panPosition.x / zoomLevel}px, ${panPosition.y / zoomLevel}px)`,
                                            transition: isPanning ? 'none' : 'transform 0.2s ease',
                                            cursor: isDrawing ? 'crosshair' : (zoomLevel > 1 ? (isPanning ? 'grabbing' : 'grab') : 'default'),
                                            userSelect: 'none',
                                            pointerEvents: 'auto'
                                        }}
                                        draggable={false}
                                    />
                                    


                                    {/* Render existing bounding boxes */}
                                    {annotations.objects.map(obj => {
                                        if (!imageRef.current) return null;
                                        
                                        // Use appropriate container based on mode
                                        const currentContainer = isFullscreen ? fullscreenContainerRef.current : containerRef.current;
                                        if (!currentContainer) return null;
                                        
                                        const bbox = obj.bbox;
                                        const imageRect = imageRef.current.getBoundingClientRect();
                                        const containerRect = currentContainer.getBoundingClientRect();
                                        // Calculate scale factors
                                        const scaleX = imageRect.width / annotations.image.width;
                                        const scaleY = imageRect.height / annotations.image.height;
                                        
                                        // Position relative to container
                                        const left = (imageRect.left - containerRect.left) + (bbox[0] * scaleX);
                                        const top = (imageRect.top - containerRect.top) + (bbox[1] * scaleY);
                                        const width = (bbox[2] - bbox[0]) * scaleX;
                                        const height = (bbox[3] - bbox[1]) * scaleY;
                                        
                                        const hasChildren = annotations.objects.some(child => child.parent_id === obj.id);
                                        const isSelected = selectedAnnotation === obj.id;
                                        const isEditing = editingBoxId === obj.id;
                                        
                                        return (
                                            <div
                                                key={obj.id}
                                                className={`bbox ${obj.type} ${isSelected ? 'selected' : ''} ${isEditing ? 'editing' : ''}`}
                                                onMouseDown={(e) => handleBboxMouseDown(e, obj.id)}
                                                style={{
                                                    left: `${left}px`,
                                                    top: `${top}px`,
                                                    width: `${width}px`,
                                                    height: `${height}px`,
                                                    position: 'absolute',
                                                    zIndex: isSelected ? 1000 : 100 - ((bbox[2] - bbox[0]) * (bbox[3] - bbox[1]) / 10000),

                                                    cursor: isDrawing ? 'crosshair' : 'move',
                                                    pointerEvents: isDrawing ? 'none' : 'auto'
                                                }}
                                            >




                                                <div className="bbox-label" style={obj.type === 'license_plate' ? { top: 'auto', bottom: '-30px' } : {}}>
                                                    {getAnnotationIcon(obj.type, obj.wheel_type)} {
													  obj.yolo_class_name
														? obj.yolo_class_name
														: (obj.type === 'vehicle'
															? (vehicleForm.category || 'VEHICLE')
															: obj.type === 'make'
															? (obj.make || 'MAKE')
															: obj.type.replace('_', ' ').toUpperCase()
														  )
													}

                                                    {obj.type === 'wheel' && obj.wheel_type && ` (${obj.wheel_type.toUpperCase()})`}
                                                    {obj.type === 'vehicle' && vehicleForm.subcategory && ` (${vehicleForm.subcategory})`}
                                                </div>                                                
                                                                                                                                                
                                                {hasChildren && (
                                                    <div className="connection-indicator">
                                                        {annotations.objects.filter(child => child.parent_id === obj.id).length}
                                                    </div>
                                                )}
                                                
                                                {/* Resize handles - only show for selected bbox */}
                                                {isSelected && (
                                                    <>
                                                        <div className="resize-handle nw" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'nw')}></div>
                                                        <div className="resize-handle ne" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'ne')}></div>
                                                        <div className="resize-handle sw" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'sw')}></div>
                                                        <div className="resize-handle se" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'se')}></div>
                                                        <div className="resize-handle n" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'n')}></div>
                                                        <div className="resize-handle s" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 's')}></div>
                                                        <div className="resize-handle w" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'w')}></div>
                                                        <div className="resize-handle e" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'e')}></div>
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}                                    

                                    {/* Render current drawing box */}
                                    {currentBox && imageRef.current && (
                                        (() => {
                                            // Use appropriate container based on mode
                                            const currentContainer = isFullscreen ? fullscreenContainerRef.current : containerRef.current;
                                            if (!currentContainer) return null;
                                            
                                            const imageRect = imageRef.current.getBoundingClientRect();
                                            const containerRect = currentContainer.getBoundingClientRect();
                                            const scaleX = imageRect.width / annotations.image.width;
                                            const scaleY = imageRect.height / annotations.image.height;
                                            
                                            const left = (imageRect.left - containerRect.left) + (currentBox.x * scaleX);
                                            const top = (imageRect.top - containerRect.top) + (currentBox.y * scaleY);
                                            const width = currentBox.width * scaleX;
                                            const height = currentBox.height * scaleY;
                                            
                                            return (
                                                <div
                                                    className={`bbox ${annotationType}`}
                                                    style={{
                                                        left: `${left}px`,
                                                        top: `${top}px`,
                                                        width: `${width}px`,
                                                        height: `${height}px`,
                                                        position: 'absolute',
                                                        zIndex: 30
                                                    }}
                                                >

                                                    <div className="bbox-label" style={annotationType === 'license_plate' ? { top: 'auto', bottom: '-30px' } : {}}>
                                                        {getAnnotationIcon(annotationType)} {annotationType === 'vehicle' ? vehicleForm.category || 'VEHICLE' : annotationType === 'make' ? makeBrand || 'MAKE' : annotationType.replace('_', ' ').toUpperCase()} [Drawing...]
                                                    </div>                                                    
                                                </div>
                                            );
                                        })()
                                    )}
                                    

                                    
                                    {/* Image info overlay */}
                                    <div style={{
                                        position: 'absolute',
                                        top: '16px',
                                        right: '16px',
                                        background: 'rgba(0,0,0,0.3)',
                                        color: 'rgba(255,255,255,0.8)',
                                        padding: '8px 12px',
                                        borderRadius: '8px',
                                        fontSize: '12px',
                                        backdropFilter: 'blur(4px)'
                                    }}>
                                        {annotations.image.width} √ó {annotations.image.height}px
                                    </div>

                                    {/* Navigation arrows */}
                                    {(imageDirectory.length > 1 || datasetIndex.filter(r => r.hasImage).length > 1) && (
                                        <>
                                            <button
                                                onClick={() => navigateToImage('prev')}
                                                style={{
                                                    position: 'absolute',
                                                    left: '16px',
                                                    top: '50%',
                                                    transform: 'translateY(-50%)',
                                                    background: 'rgba(0,0,0,0.35)',
                                                    color: 'rgba(255,255,255,0.85)',
                                                    border: 'none',
                                                    width: '50px',
                                                    height: '50px',
                                                    borderRadius: '50%',
                                                    cursor: 'pointer',
                                                    fontSize: '20px',
                                                    fontWeight: 'bold',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    zIndex: 100,
                                                    transition: 'background 0.2s ease',
                                                    backdropFilter: 'blur(4px)'
                                                }}
                                                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(0,0,0,0.6)'}
                                                onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(0,0,0,0.35)'}
                                                title="Previous image"
                                            >
                                                ‚Üê
                                            </button>

                                            <button
                                                onClick={() => navigateToImage('next')}
                                                style={{
                                                    position: 'absolute',
                                                    right: '16px',
                                                    top: '50%',
                                                    transform: 'translateY(-50%)',
                                                    background: 'rgba(0,0,0,0.35)',
                                                    color: 'rgba(255,255,255,0.85)',
                                                    border: 'none',
                                                    width: '50px',
                                                    height: '50px',
                                                    borderRadius: '50%',
                                                    cursor: 'pointer',
                                                    fontSize: '20px',
                                                    fontWeight: 'bold',
                                                    display: 'flex',
                                                    alignItems: 'center',
                                                    justifyContent: 'center',
                                                    zIndex: 100,
                                                    transition: 'background 0.2s ease',
                                                    backdropFilter: 'blur(4px)'
                                                }}
                                                onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(0,0,0,0.6)'}
                                                onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(0,0,0,0.35)'}
                                                title="Next image"
                                            >
                                                ‚Üí
                                            </button>
                                            
                                            {/* Image counter */}
                                            <div style={{
                                                position: 'absolute',
                                                bottom: '80px',
                                                left: '50%',
                                                transform: 'translateX(-50%)',
                                                background: 'rgba(0,0,0,0.35)',
                                                color: 'rgba(255,255,255,0.85)',
                                                padding: '8px 16px',
                                                borderRadius: '20px',
                                                fontSize: '14px',
                                                fontWeight: 'bold',
                                                zIndex: 100,
                                                backdropFilter: 'blur(4px)'
                                            }}>
                                                {(() => {
                                                    const imageRows = datasetIndex.filter(r => r.hasImage);
                                                    if (imageRows.length > 0 && currentBase) {
                                                        const idx = imageRows.findIndex(r => r.base === currentBase);
                                                        return `${idx >= 0 ? idx + 1 : '?'} / ${imageRows.length}`;
                                                    }
                                                    return `${currentImageIndex + 1} / ${imageDirectory.length}`;
                                                })()}
                                            </div>
                                        </>
                                    )}                                    
                                    
                                    {/* Remove button */}
                                    <button 
                                        onClick={() => {
                                            setImage(null);
                                            setImagePreview(null);
                                            setIsDrawing(false);
                                            setCurrentBox(null);
                                            setSelectedAnnotation(null);
                                            setAnnotations(prev => ({
                                                ...prev,
                                                image: { filename: "", width: 1920, height: 1080, timestamp: new Date().toISOString() },
                                                objects: []
                                            }));
                                            // Reset file input to allow re-uploading the same file
                                            if (fileInputRef.current) {
                                                fileInputRef.current.value = '';
                                            }
                                        }}
                                    


                                        style={{
                                            position: 'absolute',
                                            top: '16px',
                                            left: '16px',
                                            background: 'rgba(255,0,0,0.4)',
                                            color: 'rgba(255,255,255,0.85)',
                                            border: 'none',
                                            padding: '8px 12px',
                                            borderRadius: '8px',
                                            cursor: 'pointer',
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            backdropFilter: 'blur(4px)',
                                            transition: 'background 0.2s ease'
                                        }}
                                        onMouseEnter={(e) => e.currentTarget.style.background = 'rgba(255,0,0,0.7)'}
                                        onMouseLeave={(e) => e.currentTarget.style.background = 'rgba(255,0,0,0.4)'}
                                    >
                                        ‚úï Remove Image
                                    </button>
                                    

                                    {/* Magnifier indicator */}
                                    {/* Zoom controls */}
                                    <div style={{
                                        position: 'absolute',
                                        bottom: '16px',
                                        left: '16px',
                                        display: 'flex',
                                        gap: '8px',
                                        background: 'rgba(0,0,0,0.35)',
                                        padding: '8px',
                                        borderRadius: '12px',
                                        backdropFilter: 'blur(4px)',
                                        transition: 'background 0.2s ease'
                                    }}>
                                        <button 
                                            onClick={handleZoomOut} 
                                            style={{
                                                background: 'rgba(255,255,255,0.2)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold'
                                            }}
                                            title="Zoom Out"
                                        >
                                            ‚àí
                                        </button>
                                        <div style={{
                                            color: 'white',
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            display: 'flex',
                                            alignItems: 'center',
                                            padding: '0 8px',
                                            minWidth: '50px',
                                            textAlign: 'center'
                                        }}>
                                            {Math.round(zoomLevel * 100)}%
                                        </div>
                                        <button 
                                            onClick={handleZoomIn}
                                            style={{
                                                background: 'rgba(255,255,255,0.2)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold'
                                            }}
                                            title="Zoom In"
                                        >
                                            +
                                        </button>
                                        <button 
                                            onClick={handleZoomReset}
                                            style={{
                                                background: 'rgba(255,255,255,0.2)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold'
                                            }}
                                            title="Reset Zoom"
                                        >
                                            ‚åÇ
                                        </button>
                                        <button 
                                            onClick={() => setMagnifierEnabled(!magnifierEnabled)}
                                            style={{
                                                background: magnifierEnabled ? 'rgba(255,215,0,0.8)' : 'rgba(255,255,255,0.2)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold'
                                            }}
                                            title={magnifierEnabled ? "Disable Magnifier" : "Enable Magnifier"}
                                        >
                                            üîç
                                        </button>

                                        <button 
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                e.preventDefault();
                                                setIsFullscreen(true);
                                            }}
                                            style={{
                                                background: 'rgba(59, 130, 246, 0.8)',
                                                border: 'none',
                                                color: 'white',
                                                width: '36px',
                                                height: '36px',
                                                borderRadius: '8px',
                                                cursor: 'pointer',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'center',
                                                fontWeight: 'bold',
                                                zIndex: 1000
                                            }}
                                            title="Fullscreen Mode (or press F)"
                                        >
                                            ‚õ∂
                                        </button>                                       
                                    </div>


                                    {/* Magnifier */}
                                    {showMagnifier && magnifierEnabled && ( 
                                        <div
                                            style={{
                                                position: 'fixed',
                                                left: `${magnifierPosition.x}px`,
                                                top: `${magnifierPosition.y}px`,
                                                width: `${magnifierSize}px`,
                                                height: `${magnifierSize}px`,
                                                border: '2px solid rgba(255,255,255,0.7)',
                                                borderRadius: '50%',
                                                boxShadow: '0 0 15px rgba(0,0,0,0.3)',
                                                backgroundImage: `url(${imagePreview})`,
                                                backgroundRepeat: 'no-repeat',
                                                backgroundSize: `${annotations.image.width * magnificationLevel}px ${annotations.image.height * magnificationLevel}px`,
                                                backgroundPosition: `-${magnifierImagePosition.x * magnificationLevel - magnifierSize/2}px -${magnifierImagePosition.y * magnificationLevel - magnifierSize/2}px`,
                                                pointerEvents: 'none',
                                                zIndex: 1000
                                            }}
                                        />
                                    )}

                                </div>
                            )}

                            {/* Keyboard Shortcuts - always visible at bottom */}
                            <div style={{
                                marginTop: 'auto',
                                paddingTop: '12px',
                                borderTop: '1px solid #e5e7eb'
                            }}>
                                <div style={{ fontSize: '11px', fontWeight: 'bold', marginBottom: '6px', color: '#6b7280', textAlign: 'center' }}>
                                    ‚å®Ô∏è Keyboard Shortcuts
                                </div>
                                <div style={{
                                    display: 'grid',
                                    gridTemplateColumns: '1fr 1fr 1fr',
                                    gap: '2px 16px',
                                    fontSize: '10px',
                                    color: '#6b7280'
                                }}>
                                    <div><strong>Ctrl+Z:</strong> Undo last action</div>
                                    <div><strong>Ctrl+Y:</strong> Redo action</div>
                                    <div><strong>Delete/Backspace:</strong> Remove selected annotation</div>
                                    <div><strong>1,2,3,4,5,6:</strong> Change selected annotation type</div>
                                    <div><strong>S:</strong> Select save directory</div>
                                    <div><strong>Ctrl+S:</strong> Save JSON + Annotated Image</div>
                                    <div><strong>W:</strong> Toggle drawing mode</div>
                                    <div><strong>F:</strong> Enter fullscreen mode</div>
                                    <div><strong>Escape:</strong> Exit fullscreen, cancel drawing, or deselect</div>
                                    <div><strong>Ctrl+Shift+S:</strong> Save all annotated images</div>
                                    <div><strong>‚Üê ‚Üí:</strong> Navigate images (in fullscreen)</div>
                                </div>
                            </div>
                        </div>


                        {/* Right Panel - Image & Vehicle Information Forms */}
                        <div className="card" style={{ padding: '24px' }}>
                            <div className="scrollable-panel">
                                <h2 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    üñºÔ∏è Image Properties
                                </h2>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Site Location</label>
                                        <select
                                            className="input-field input-small"
                                            value={imagePropertiesForm.site_location}
                                            onChange={(e) => setImagePropertiesForm(prev => ({ ...prev, site_location: e.target.value }))}
                                        >
                                            <option value="Toll">Toll</option>
                                            <option value="Weight in Motion (WIM)">Weight in Motion (WIM)</option>
                                            <option value="Freeflow">Freeflow</option>
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Scene</label>
                                        <select
                                            className="input-field input-small"
                                            value={imagePropertiesForm.scene}
                                            onChange={(e) => setImagePropertiesForm(prev => ({ ...prev, scene: e.target.value }))}
                                        >
                                            <option value="day">Day</option>
                                            <option value="night">Night</option>
                                            <option value="twilight">Twilight</option>
                                        </select>
                                    </div>
                                </div>
								
								<div className="form-row">
									<div className="form-group">
										<label className="form-label">Camera Position</label>
										<select
											className="input-field input-small"
											value={imagePropertiesForm.camera_position}
											onChange={(e) =>
												setImagePropertiesForm(prev => ({ ...prev, camera_position: e.target.value }))
											}
										>
											<option value="front">Front</option>
											<option value="rear">Rear</option>
											<option value="side">Side</option>
										</select>
									</div>

									<div className="form-group">
										<label className="form-label">Image Type</label>
										<select
											className="input-field input-small"
											value={imagePropertiesForm.image_type}
											onChange={(e) =>
												setImagePropertiesForm(prev => ({ ...prev, image_type: e.target.value }))
											}
										>
											<option value="RGB">RGB</option>
											<option value="gray">gray</option>
										</select>
									</div>
								</div>

								<div className="checkbox-grid">
									<label className="checkbox-item">
										<input
											type="checkbox"
											checked={imagePropertiesForm.is_rain}
											onChange={(e) =>
												setImagePropertiesForm(prev => ({ ...prev, is_rain: e.target.checked }))
											}
										/>
										üåßÔ∏è Rain
									</label>
								</div>

                                <hr style={{ border: 'none', borderTop: '1px solid rgba(255,255,255,0.1)', margin: '20px 0' }} />

                                <h2 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                    ‚öôÔ∏è Vehicle Properties
                                </h2>
                                

                                
                                {/* Basic Information */}
                                <div className="section-header">
                                    üöó Basic Information
                                </div>
                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Category</label>
                                        <select
                                            className="input-field input-small"
                                            value={vehicleForm.category}
                                            onChange={(e) => setVehicleForm(prev => ({
                                                ...prev,
                                                category: e.target.value,
                                                subcategory: ''
                                            }))}
                                        >
                                            {Object.keys(vehicleCategories).map(cat => (
                                                <option key={cat} value={cat}>{cat}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Subcategory</label>
                                        <select
                                            className="input-field input-small"
                                            value={vehicleForm.subcategory}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, subcategory: e.target.value }))}
                                        >
                                            <option value="">Select...</option>
                                            {vehicleCategories[vehicleForm.category]?.map(subcat => (
                                                <option key={subcat} value={subcat}>{subcat}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Color</label>
                                        <select
                                            className="input-field input-small"
                                            value={vehicleForm.color}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, color: e.target.value }))}
                                        >
                                            <option value="">Select color...</option>
                                            {colors.map(color => (
                                                <option key={color} value={color}>{color}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Direction</label>
                                        <select
                                            className="input-field input-small"
                                            value={vehicleForm.direction}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, direction: e.target.value }))}
                                        >
                                            {directions.map(dir => (
                                                <option key={dir} value={dir}>{dir.replace('_', ' ')}</option>
                                            ))}
                                        </select>
                                    </div>
                                </div>


                                {/* License Plate Information */}
                                <div className="section-header" style={{ marginTop: '20px' }}>
                                    üî¢ License Plate Information
                                </div>

                                <div className="checkbox-grid">
                                    <label className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={vehicleForm.license_plate_visible}
                                            onChange={(e) => {
                                                if (e.target.checked) {
                                                    setVehicleForm(prev => ({
                                                        ...prev,
                                                        license_plate_visible: true,
                                                        license_plate_blurred: false
                                                    }));
                                                } else {
                                                    setVehicleForm(prev => ({
                                                        ...prev,
                                                        license_plate_visible: false,
                                                        license_plate_text: ''
                                                    }));
                                                }
                                            }}
                                        />
                                        Visible
                                    </label>
                                    <label className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={vehicleForm.license_plate_blurred}
                                            onChange={(e) => {
                                                if (e.target.checked) {
                                                    setVehicleForm(prev => ({
                                                        ...prev,
                                                        license_plate_blurred: true,
                                                        license_plate_visible: false,
                                                        license_plate_text: ''
                                                    }));
                                                } else {
                                                    setVehicleForm(prev => ({
                                                        ...prev,
                                                        license_plate_blurred: false
                                                    }));
                                                }
                                            }}
                                        />
                                        Blurred
                                    </label>
                                </div>

                                <div className="form-group">
                                    <label className="form-label">License Plate Text</label>
                                    <input
                                        className="input-field input-small"
                                        placeholder={vehicleForm.license_plate_blurred ? "Text unavailable (blurred)" : vehicleForm.license_plate_visible ? "e.g. WXD1023" : "Not visible"}
                                        value={vehicleForm.license_plate_text}
                                        disabled={vehicleForm.license_plate_blurred || !vehicleForm.license_plate_visible}
                                        onChange={(e) => setVehicleForm(prev => ({ ...prev, license_plate_text: e.target.value.toUpperCase() }))}
                                        style={{
                                            backgroundColor: vehicleForm.license_plate_blurred || !vehicleForm.license_plate_visible ? '#f5f5f5' : 'white',
                                            color: vehicleForm.license_plate_blurred || !vehicleForm.license_plate_visible ? '#999' : 'black'
                                        }}
                                    />
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Plate Country</label>
                                        <input
                                            className="input-field input-small"
                                            value={vehicleForm.license_plate_country}
                                            disabled={!vehicleForm.license_plate_visible}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, license_plate_country: e.target.value }))}
                                            style={{
                                                backgroundColor: !vehicleForm.license_plate_visible ? '#f5f5f5' : 'white',
                                                color: !vehicleForm.license_plate_visible ? '#999' : 'black'
                                            }}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Plate Format</label>
                                        <select
                                            className="input-field input-small"
                                            value={vehicleForm.license_plate_format}
                                            disabled={!vehicleForm.license_plate_visible}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, license_plate_format: e.target.value }))}
                                            style={{
                                                backgroundColor: !vehicleForm.license_plate_visible ? '#f5f5f5' : 'white',
                                                color: !vehicleForm.license_plate_visible ? '#999' : 'black'
                                            }}
                                        >
                                            <option value="License_Plate_Normal">License Plate Normal</option>
                                            <option value="License_Plate_Taxi">License Plate Taxi</option>
                                            <option value="Trailer_Plate">Trailer Plate</option>
                                            <option value="Diplomatic_Plate">Diplomatic Plate</option>
                                            <option value="Thai_Plate">Thai Plate</option>
                                            <option value="EV_Plate">EV Plate</option>
                                        </select>
                                    </div>
                                </div>

                                {/* Mechanical Properties */}
                                <div className="section-header">
                                    ‚öôÔ∏è Mechanical Properties
                                </div>

                                <div className="form-row">
                                    <div className="form-group">
                                        <label className="form-label">Inferred Axles</label>
                                        <input
                                            type="number"
                                            className="input-field input-small"
                                            min="0"
                                            value={vehicleForm.number_of_axles_inferred}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, number_of_axles_inferred: parseInt(e.target.value) }))}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Raised Axles</label>
                                        <input
                                            type="number"
                                            className="input-field input-small"
                                            min="0"
                                            value={vehicleForm.number_of_axles_raised}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, number_of_axles_raised: parseInt(e.target.value) }))}
                                        />
                                    </div>
                                </div>

                                <div className="checkbox-grid">
                                    <label className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={vehicleForm.truck_trailer_labels_visible}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, truck_trailer_labels_visible: e.target.checked }))}
                                        />
                                        Trailer Labels Visible
                                    </label>
                                    <label className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={vehicleForm.cargo_present}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, cargo_present: e.target.checked }))}
                                        />
                                        Cargo Present
                                    </label>
                                </div>

                                {/* Vehicle Attributes */}
                                <div className="section-header">
                                    üè∑Ô∏è Vehicle Attributes
                                </div>

                                <div className="checkbox-grid">
                                    <label className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={vehicleForm.is_taxi}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, is_taxi: e.target.checked }))}
                                        />
                                        üöï Taxi
                                    </label>
                                    <label className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={vehicleForm.is_bus}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, is_bus: e.target.checked }))}
                                        />
                                        üöå Bus
                                    </label>
                                    <label className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={vehicleForm.is_emergency_vehicle}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, is_emergency_vehicle: e.target.checked }))}
                                        />
                                        üö® Emergency
                                    </label>
                                    <label className="checkbox-item">
                                        <input
                                            type="checkbox"
                                            checked={vehicleForm.is_electric}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, is_electric: e.target.checked }))}
                                        />
                                        ‚ö° Electric
                                    </label>
                                </div>

                                {vehicleForm.is_bus && (
                                    <div className="form-group">
                                        <label className="form-label">Bus Type</label>
                                        <select
                                            className="input-field input-small"
                                            value={vehicleForm.bus_type}
                                            onChange={(e) => setVehicleForm(prev => ({ ...prev, bus_type: e.target.value }))}
                                        >
                                            <option value="">Select bus type...</option>
                                            <option value="city">City Bus</option>
                                            <option value="school">School Bus</option>
                                            <option value="tour">Tour Bus</option>
                                            <option value="double_decker">Double Decker</option>
                                            <option value="shuttle">Shuttle</option>
                                        </select>
                                    </div>
                                )}
                                
                                <button 
                                    className="btn-secondary"
                                    style={{ 
                                        width: '100%', 
                                        marginBottom: '8px',
                                        background: selectedAnnotation ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)',
                                        opacity: selectedAnnotation ? 1 : 0.5
                                    }}
                                    onClick={updateSelectedAnnotationWithForm}
                                    disabled={!selectedAnnotation} // Only disable if no annotation is selected
                                >
                                    üìù Update Selected Annotation {selectedAnnotation ? '‚úÖ' : '‚ùå'}
                                </button>



                                {/* Quick Actions */}
                                <div style={{ marginTop: '24px', paddingTop: '16px', borderTop: '2px solid #e5e7eb' }}>
                                    <div className="section-header">
                                        ‚ö° Quick Actions
                                    </div>
                                    
                                    <button 
                                        className="btn-secondary"
                                        style={{ width: '100%', marginBottom: '8px' }}
                                        onClick={() => {
                                            setVehicleForm({
                                                category: 'Light Vehicle',
                                                subcategory: 'Sedan',
                                                country: 'MY',
                                                make: '',
                                                model: '',
                                                color: '',
                                                direction: 'Northbound',
                                                number_of_axles_inferred: 2,
                                                number_of_axles_raised: 0,
                                                truck_trailer_labels_visible: false,
                                                cargo_present: false,
                                                is_taxi: false,
                                                is_bus: false,
                                                bus_type: '',
                                                is_emergency_vehicle: false,
                                                is_electric: false,
                                                license_plate_text: '',
                                                license_plate_country: 'MY',
                                                license_plate_format: 'License_Plate_Normal',

                                                license_plate_blurred: false,
                                                license_plate_visible: true
                                            });
                                        }}
                                    >
                                        üîÑ Reset Form
                                    </button>

                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px', marginBottom: '8px' }}>
                                        <button 
                                            className="btn-secondary"
                                            onClick={undo}
                                            disabled={undoHistory.length === 0}
                                            style={{ 
                                                background: undoHistory.length === 0 ? 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)' : 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
                                                opacity: undoHistory.length === 0 ? 0.5 : 1
                                            }}
                                            title="Undo (Ctrl+Z)"
                                        >
                                            ‚Ü∂ Undo
                                        </button>
                                        
                                        <button 
                                            className="btn-secondary"
                                            onClick={redo}
                                            disabled={redoHistory.length === 0}
                                            style={{ 
                                                background: redoHistory.length === 0 ? 'linear-gradient(135deg, #94a3b8 0%, #64748b 100%)' : 'linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%)',
                                                opacity: redoHistory.length === 0 ? 0.5 : 1
                                            }}
                                            title="Redo (Ctrl+Y)"
                                        >
                                            ‚Ü∑ Redo
                                        </button>
                                    </div>                                    
                                    
                                    <button 
                                        className="btn-secondary"
                                        style={{ width: '100%', marginBottom: '8px' }}
                                        onClick={() => {
                                            setVehicleForm(prev => ({
                                                ...prev,
                                                category: 'Heavy Vehicle',
                                                subcategory: 'Prime Mover',
                                                number_of_axles_inferred: 5,
                                                truck_trailer_labels_visible: true,
                                                cargo_present: true
                                            }));
                                        }}
                                    >
                                        üöõ Heavy Vehicle Preset
                                    </button>
                                    
                                    <button 
                                        className="btn-secondary"
                                        style={{ width: '100%' }}
                                        onClick={() => {
                                            setVehicleForm(prev => ({
                                                ...prev,
                                                category: 'Bus',
                                                subcategory: 'City Bus',
                                                is_bus: true,
                                                bus_type: 'city',
                                                number_of_axles_inferred: 3
                                            }));
                                        }}
                                    >
                                        üöå Bus Preset
                                    </button>
                                </div>
                                
                                {/* Selected Annotation Info */}
                                {selectedAnnotation && (
                                    <div style={{ marginTop: '20px' }}>
                                        <div className="section-header">
                                            üìù Selected Annotation
                                        </div>
                                        {(() => {
                                            const selected = annotations.objects.find(obj => obj.id === selectedAnnotation);
                                            if (!selected) return null;
                                            
                                            return (
                                                <div style={{ 
                                                    padding: '12px', 
                                                    background: '#fff3cd', 
                                                    border: '2px solid #ffc107', 
                                                    borderRadius: '8px',
                                                    fontSize: '12px'
                                                }}>
                                                    <div style={{ fontWeight: 'bold', marginBottom: '8px' }}>
                                                        {getAnnotationIcon(selected.type, selected.wheel_type)} {selected.type === 'make' ? (selected.make ? `MAKE - ${selected.make}` : 'MAKE') : selected.type.replace('_', ' ').toUpperCase()}

                                                    </div>
                                                    
                                                    <div style={{ 
                                                        marginTop: '8px', 
                                                        padding: '8px', 
                                                        background: 'rgba(255,0,0,0.1)', 
                                                        borderRadius: '4px', 
                                                        fontSize: '11px',
                                                        color: '#dc3545',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        üí° Press DELETE or BACKSPACE to remove this annotation
                                                    </div>
                                                    
                                                    {/* Type Selector - ADD THIS INSIDE THE RETURN BLOCK */}
                                                    <div style={{ marginTop: '12px' }}>
                                                        <label className="form-label">Change Annotation Type</label>
                                                        <select 
                                                            className="input-field input-small"
                                                            value={selected.type}
                                                            onChange={(e) => {
                                                                const newType = e.target.value;
                                                                saveToHistory(annotations);
                                                                setAnnotations(prev => ({
                                                                    ...prev,
                                                                    objects: prev.objects.map(obj => 
                                                                        obj.id === selectedAnnotation 
                                                                            ? { ...obj, type: newType }
                                                                            : obj
                                                                    )
                                                                }));
                                                            }}
                                                        >
                                                            <option value="vehicle">üöó Vehicle</option>
                                                            <option value="license_plate">üî¢ License Plate</option>
                                                            <option value="wheel">‚öôÔ∏è Wheel</option>
                                                            <option value="attachment">üöõ Attachment/Trailer</option>
                                                        </select>
                                                        
                                                        <div style={{ marginTop: '8px' }}>
                                                            <div style={{ fontSize: '11px', fontWeight: 'bold', marginBottom: '6px', color: '#374151' }}>
                                                                Quick Change:
                                                            </div>
                                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '4px' }}>
                                                                <button 
                                                                    className="btn-secondary"
                                                                    style={{ 
                                                                        fontSize: '9px', 
                                                                        padding: '4px 6px',
                                                                        background: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)'
                                                                    }}
                                                                    onClick={() => {
                                                                        saveToHistory(annotations);
                                                                        setAnnotations(prev => ({
                                                                            ...prev,
                                                                            objects: prev.objects.map(obj => 
                                                                                obj.id === selectedAnnotation 
                                                                                    ? { ...obj, type: 'vehicle' }
                                                                                    : obj
                                                                            )
                                                                        }));
                                                                    }}
                                                                >
                                                                    üöó Vehicle
                                                                </button>
                                                                <button 
                                                                    className="btn-secondary"
                                                                    style={{ 
                                                                        fontSize: '9px', 
                                                                        padding: '4px 6px',
                                                                        background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'
                                                                    }}
                                                                    onClick={() => {
                                                                        saveToHistory(annotations);
                                                                        setAnnotations(prev => ({
                                                                            ...prev,
                                                                            objects: prev.objects.map(obj => 
                                                                                obj.id === selectedAnnotation 
                                                                                    ? { ...obj, type: 'license_plate' }
                                                                                    : obj
                                                                            )
                                                                        }));
                                                                    }}
                                                                >
                                                                    üî¢ Plate
                                                                </button>
                                                                <button 
                                                                    className="btn-secondary"
                                                                    style={{ 
                                                                        fontSize: '9px', 
                                                                        padding: '4px 6px',
                                                                        background: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
                                                                    }}
                                                                    onClick={() => {
                                                                        saveToHistory(annotations);
                                                                        setAnnotations(prev => ({
                                                                            ...prev,
                                                                            objects: prev.objects.map(obj => 
                                                                                obj.id === selectedAnnotation 
                                                                                    ? { ...obj, type: 'wheel' }
                                                                                    : obj
                                                                            )
                                                                        }));
                                                                    }}
                                                                >
                                                                    ‚öôÔ∏è Wheel
                                                                </button>
                                                                <button 
                                                                    className="btn-secondary"
                                                                    style={{ 
                                                                        fontSize: '9px', 
                                                                        padding: '4px 6px',
                                                                        background: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)'
                                                                    }}
                                                                    onClick={() => {
                                                                        saveToHistory(annotations);
                                                                        setAnnotations(prev => ({
                                                                            ...prev,
                                                                            objects: prev.objects.map(obj => 
                                                                                obj.id === selectedAnnotation 
                                                                                    ? { ...obj, type: 'attachment' }
                                                                                    : obj
                                                                            )
                                                                        }));
                                                                    }}
                                                                >
                                                                    üöõ Attachment
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                )}



                                
                                {/* JSON Preview */}
                                {annotations.objects.length > 0 && (
                                    <div style={{ marginTop: '20px' }}>
                                        <div className="section-header">
                                            üìÑ JSON Preview
                                        </div>
                                        <div style={{ 
                                            background: '#f8f9fa', 
                                            border: '1px solid #e9ecef', 
                                            borderRadius: '8px',
                                            padding: '12px',
                                            fontSize: '10px',
                                            fontFamily: 'monospace',
                                            maxHeight: '200px',
                                            overflowY: 'auto'
                                        }}>
                                            <pre style={{ margin: 0, whiteSpace: 'pre-wrap' }}>
                                                {JSON.stringify({
                                                    image: annotations.image,
                                                    objects: annotations.objects.slice(0, 1) // Show first object as preview
                                                }, null, 2)}
                                                {annotations.objects.length > 1 && `\n... and ${annotations.objects.length - 1} more objects`}
                                            </pre>
                                        </div>
                                    </div>
                                )}
                                                              
                            </div>
                        </div>
                        {/* Fullscreen Modal */}
                        {isFullscreen && imagePreview && (
                            <div className="fullscreen-overlay" onClick={() => setIsFullscreen(false)}>
                                <div className="fullscreen-container" onClick={(e) => e.stopPropagation()}>
                                    {/* Fullscreen Toolbar */}
                                    <div className="fullscreen-toolbar">
                                        <button 
                                            className={`fullscreen-btn ${isDrawing ? 'active' : ''}`}
                                            onClick={() => setIsDrawing(!isDrawing)}
                                        >
                                            {isDrawing ? 'üéØ Drawing ON' : '‚úèÔ∏è Start Drawing'}
                                        </button>
                                        
                                        <select 
                                            value={annotationType}
                                            onChange={(e) => setAnnotationType(e.target.value)}
                                            className="fullscreen-btn"
                                            style={{
                                                background: 'rgba(255, 255, 255, 0.2)',
                                                border: 'none',
                                                color: 'white',
                                                padding: '8px 12px',
                                                borderRadius: '6px',
                                                fontSize: '12px'
                                            }}
                                        >
                                            <option value="vehicle" style={{ color: 'black' }}>üöó Vehicle</option>
                                            <option value="license_plate" style={{ color: 'black' }}>üî¢ License Plate</option>
                                            <option value="wheel" style={{ color: 'black' }}>‚öôÔ∏è Wheel</option>
                                            <option value="attachment" style={{ color: 'black' }}>üöõ Attachment</option>
                                            <option value="make" style={{ color: 'black' }}>üè∑Ô∏è Make (Logo/Brand)</option>
                                        </select>
                                        
                                        {annotationType === 'wheel' && (
                                            <select 
                                                value={wheelType}
                                                onChange={(e) => setWheelType(e.target.value)}
                                                className="fullscreen-btn"
                                                style={{
                                                    background: 'rgba(255, 255, 255, 0.2)',
                                                    border: 'none',
                                                    color: 'white',
                                                    padding: '8px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '12px'
                                                }}
                                            >
                                                <option value="single" style={{ color: 'black' }}>üîò Single</option>
                                                <option value="double" style={{ color: 'black' }}>‚ö´‚ö´ Double</option>
                                            </select>
                                        )}

                                        {annotationType === 'make' && (
                                            <input
                                                className="fullscreen-btn"
                                                style={{
                                                    background: 'rgba(255, 255, 255, 0.2)',
                                                    border: 'none',
                                                    color: 'white',
                                                    padding: '8px 12px',
                                                    borderRadius: '6px',
                                                    fontSize: '12px',
                                                    width: '150px'
                                                }}
                                                placeholder="Make name..."
                                                value={makeBrand}
                                                onChange={(e) => setMakeBrand(e.target.value)}
                                            />
                                        )}

                                        <button
                                            className={`fullscreen-btn ${magnifierEnabled ? 'active' : ''}`}
                                            onClick={() => setMagnifierEnabled(!magnifierEnabled)}
                                            style={{ 
                                                background: magnifierEnabled ? 'rgba(255, 215, 0, 0.8)' : 'rgba(255, 255, 255, 0.2)' 
                                            }}
                                        >
                                            üîç {magnifierEnabled ? 'Disable' : 'Enable'} Magnifier
                                        </button>

                                        
                                        <button 
                                            className="fullscreen-btn"
                                            onClick={() => setIsFullscreen(false)}
                                            style={{ background: 'rgba(255, 0, 0, 0.8)' }}
                                        >
                                            ‚úï Exit Fullscreen
                                        </button>
                                    </div>
                                    
                                    {/* Fullscreen Image Container */}
                                    <div 
                                        ref={fullscreenContainerRef}
                                        style={{ 
                                            position: 'relative',
                                            width: '100%',
                                            height: '100%',
                                            display: 'flex',
                                            alignItems: 'center',
                                            justifyContent: 'center',
                                            cursor: isDrawing ? 'crosshair' : 'default',
                                            overflow: 'hidden'
                                        }}
                                        onMouseDown={handleImageMouseDown}
                                        onMouseMove={handleMouseMove}
                                        onMouseLeave={handleMouseLeave}
                                        onWheel={handleWheel}
                                    >
                                        <img 
                                            ref={imageRef}
                                            key={`fullscreen-${isFullscreen}`}
                                            src={imagePreview} 
                                            alt="Vehicle for annotation"
                                            style={{
                                                maxWidth: '100%',
                                                maxHeight: '100%',
                                                objectFit: 'contain',
                                                transform: `scale(${zoomLevel}) translate(${panPosition.x / zoomLevel}px, ${panPosition.y / zoomLevel}px)`,
                                                transition: isPanning ? 'none' : 'transform 0.2s ease',
                                                cursor: isDrawing ? 'crosshair' : (zoomLevel > 1 ? (isPanning ? 'grabbing' : 'grab') : 'default'),
                                                userSelect: 'none'
                                            }}
                                            draggable={false}
                                        />
                                        
                                        {/* Render existing bounding boxes in fullscreen */}
                                        {annotations.objects.map(obj => {
                                            if (!imageRef.current || !fullscreenContainerRef.current) return null;

                                            
                                            const bbox = obj.bbox;
                                            const imageRect = imageRef.current.getBoundingClientRect();
                                            const containerRect = fullscreenContainerRef.current.getBoundingClientRect();
                                            
                                            const scaleX = imageRect.width / annotations.image.width;
                                            const scaleY = imageRect.height / annotations.image.height;
                                            
                                            const left = (imageRect.left - containerRect.left) + (bbox[0] * scaleX);
                                            const top = (imageRect.top - containerRect.top) + (bbox[1] * scaleY);
                                            const width = (bbox[2] - bbox[0]) * scaleX;
                                            const height = (bbox[3] - bbox[1]) * scaleY;
                                            
                                            const hasChildren = annotations.objects.some(child => child.parent_id === obj.id);
                                            const isSelected = selectedAnnotation === obj.id;
                                            const isEditing = editingBoxId === obj.id;
                                            
                                            return (
                                                <div
                                                    key={obj.id}
                                                    className={`bbox ${obj.type} ${isSelected ? 'selected' : ''} ${isEditing ? 'editing' : ''}`}
                                                    onMouseDown={(e) => handleBboxMouseDown(e, obj.id)}
                                                    style={{
                                                        left: `${left}px`,
                                                        top: `${top}px`,
                                                        width: `${width}px`,
                                                        height: `${height}px`,
                                                        position: 'absolute',
                                                        zIndex: isSelected ? 1000 : 100 - ((bbox[2] - bbox[0]) * (bbox[3] - bbox[1]) / 10000),

                                                        cursor: isDrawing ? 'crosshair' : 'move',
                                                        pointerEvents: isDrawing ? 'none' : 'auto'
                                                    }}
                                                >

                                                    <div className="bbox-label" style={obj.type === 'license_plate' ? { top: 'auto', bottom: '-30px' } : {}}>
                                                        {getAnnotationIcon(obj.type, obj.wheel_type)} {obj.type === 'vehicle' ? (vehicleForm.category || 'VEHICLE') : obj.type === 'make' ? (obj.make || 'MAKE') : obj.type.replace('_', ' ').toUpperCase()}
                                                        {obj.type === 'wheel' && obj.wheel_type && ` (${obj.wheel_type.toUpperCase()})`}
                                                        {obj.type === 'vehicle' && vehicleForm.subcategory && ` (${vehicleForm.subcategory})`}
                                                    </div>

                                                    {hasChildren && (
                                                        <div className="connection-indicator">
                                                            {annotations.objects.filter(child => child.parent_id === obj.id).length}
                                                        </div>
                                                    )}

                                                    {isSelected && (
                                                        <>
                                                            <div className="resize-handle nw" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'nw')}></div>
                                                            <div className="resize-handle ne" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'ne')}></div>
                                                            <div className="resize-handle sw" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'sw')}></div>
                                                            <div className="resize-handle se" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'se')}></div>
                                                            <div className="resize-handle n" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'n')}></div>
                                                            <div className="resize-handle s" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 's')}></div>
                                                            <div className="resize-handle w" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'w')}></div>
                                                            <div className="resize-handle e" onMouseDown={(e) => handleBboxMouseDown(e, obj.id, 'e')}></div>
                                                        </>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        
                                        {/* Render current drawing box in fullscreen */}
                                        {currentBox && imageRef.current && fullscreenContainerRef.current && (
                                            (() => {
                                                const imageRect = imageRef.current.getBoundingClientRect();
                                                const containerRect = fullscreenContainerRef.current.getBoundingClientRect();
                                                
                                                const scaleX = imageRect.width / annotations.image.width;
                                                const scaleY = imageRect.height / annotations.image.height;
                                                
                                                const left = (imageRect.left - containerRect.left) + (currentBox.x * scaleX);
                                                const top = (imageRect.top - containerRect.top) + (currentBox.y * scaleY);
                                                const width = currentBox.width * scaleX;
                                                const height = currentBox.height * scaleY;
                                                
                                                return (
                                                    <div
                                                        className={`bbox ${annotationType}`}
                                                        style={{
                                                            left: `${left}px`,
                                                            top: `${top}px`,
                                                            width: `${width}px`,
                                                            height: `${height}px`,
                                                            position: 'absolute',
                                                            zIndex: 30
                                                        }}
                                                    >

                                                        <div className="bbox-label">
                                                            {getAnnotationIcon(annotationType)} {annotationType === 'vehicle' ? vehicleForm.category || 'VEHICLE' : annotationType === 'make' ? makeBrand || 'MAKE' : annotationType.replace('_', ' ').toUpperCase()} [Drawing...]
                                                        </div>                                                        
                                                    </div>
                                                );
                                            })()
                                        )}
                                        
                                        {/* Magnifier in fullscreen */}
                                        {showMagnifier && magnifierEnabled && ( 
                                            <div
                                                style={{
                                                    position: 'fixed',
                                                    left: `${magnifierPosition.x}px`,
                                                    top: `${magnifierPosition.y}px`,
                                                    width: `${magnifierSize}px`,
                                                    height: `${magnifierSize}px`,
                                                    border: '3px solid #fff',
                                                    borderRadius: '50%',
                                                    boxShadow: '0 0 20px rgba(0,0,0,0.5)',
                                                    backgroundImage: `url(${imagePreview})`,
                                                    backgroundRepeat: 'no-repeat',
                                                    backgroundSize: `${annotations.image.width * magnificationLevel}px ${annotations.image.height * magnificationLevel}px`,
                                                    backgroundPosition: `-${magnifierImagePosition.x * magnificationLevel - magnifierSize/2}px -${magnifierImagePosition.y * magnificationLevel - magnifierSize/2}px`,
                                                    pointerEvents: 'none',
                                                    zIndex: 1000
                                                }}
                                            />
                                        )}
                                    </div>
                                    
                                    {/* Fullscreen zoom controls */}
                                    <div style={{
                                        position: 'absolute',
                                        bottom: '20px',
                                        left: '20px',
                                        display: 'flex',
                                        gap: '8px',
                                        background: 'rgba(0,0,0,0.8)',
                                        padding: '8px',
                                        borderRadius: '12px'
                                    }}>
                                        <button 
                                            onClick={handleZoomOut} 
                                            className="fullscreen-btn"
                                            style={{ width: '36px', height: '36px', padding: '0' }}
                                        >
                                            ‚àí
                                        </button>
                                        <div style={{
                                            color: 'white',
                                            fontSize: '12px',
                                            fontWeight: 'bold',
                                            display: 'flex',
                                            alignItems: 'center',
                                            padding: '0 8px'
                                        }}>
                                            {Math.round(zoomLevel * 100)}%
                                        </div>
                                        <button 
                                            onClick={handleZoomIn}
                                            className="fullscreen-btn"
                                            style={{ width: '36px', height: '36px', padding: '0' }}
                                        >
                                            +
                                        </button>
                                        <button 
                                            onClick={handleZoomReset}
                                            className="fullscreen-btn"
                                            style={{ width: '36px', height: '36px', padding: '0' }}
                                        >
                                            ‚åÇ
                                        </button>
                                    </div>

                                    {/* Annotations list in fullscreen */}
                                    {annotations.objects.length > 0 && (
                                        <div style={{
                                            position: 'absolute',
                                            bottom: '80px',  // <-- MOVED UP FROM 20px TO 80px
                                            left: '20px',    // <-- ALIGNED WITH ZOOM CONTROLS
                                            background: 'rgba(0,0,0,0.9)',
                                            padding: '16px',
                                            borderRadius: '12px',
                                            maxWidth: '300px',
                                            maxHeight: '400px',
                                            overflowY: 'auto'
                                        }}>
                                            <div style={{
                                                color: 'white',
                                                fontSize: '14px',
                                                fontWeight: 'bold',
                                                marginBottom: '12px',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '8px'
                                            }}>
                                                üìã Annotations ({annotations.objects.length})
                                            </div>
                                            
                                            {annotations.objects.map((obj, index) => (
                                                <div 
                                                    key={obj.id}
                                                    onClick={() => setSelectedAnnotation(obj.id)}
                                                    style={{
                                                        padding: '8px 12px',
                                                        background: selectedAnnotation === obj.id ? 'rgba(255, 215, 0, 0.3)' : 'rgba(255,255,255,0.1)',
                                                        border: selectedAnnotation === obj.id ? '2px solid #ffd700' : '1px solid rgba(255,255,255,0.2)',
                                                        borderRadius: '6px',
                                                        marginBottom: '6px',
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        justifyContent: 'space-between',
                                                        alignItems: 'center',
                                                        transition: 'all 0.2s ease'
                                                    }}
                                                >
                                                    <div>
                                                        <div style={{
                                                            color: 'white',
                                                            fontSize: '12px',
                                                            fontWeight: 'bold',
                                                            marginBottom: '2px'
                                                        }}>
                                                            {getAnnotationIcon(obj.type, obj.wheel_type)} {obj.type === 'make' ? (obj.make ? `MAKE - ${obj.make}` : 'MAKE') : obj.type.replace('_', ' ').toUpperCase()}
                                                            {obj.type === 'wheel' && obj.wheel_type && ` (${obj.wheel_type.toUpperCase()})`}
                                                        </div>
                                                        <div style={{
                                                            color: '#ccc',
                                                            fontSize: '10px'
                                                        }}>
                                                            {Math.round(obj.bbox[2] - obj.bbox[0])}√ó{Math.round(obj.bbox[3] - obj.bbox[1])}px

                                                            {obj.license_plate?.text && (
                                                                <span> ‚Ä¢ {obj.license_plate.text}</span>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            saveToHistory(annotations);
                                                            deleteAnnotation(obj.id);
                                                        }}
                                                        style={{
                                                            background: '#dc3545',
                                                            color: 'white',
                                                            border: 'none',
                                                            borderRadius: '4px',
                                                            padding: '4px 8px',
                                                            fontSize: '10px',
                                                            cursor: 'pointer'
                                                        }}
                                                    >
                                                        ‚úï
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>


                </div>
            );
        };
        
        ReactDOM.render(<AdvancedVehicleAnnotationTool />, document.getElementById('root'));
    </script>
</body>
</html>





