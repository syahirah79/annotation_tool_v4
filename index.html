<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>YOLO Folder Annotation Tool (Images + Labels)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #0b1220; color: #e8eefc; }
    header { padding: 14px 16px; border-bottom: 1px solid #24304a; display:flex; gap:12px; align-items:center; }
    header h1 { font-size: 16px; margin: 0; font-weight: 600; }
    header .muted { opacity: .8; font-size: 13px; }

    .wrap { display: grid; grid-template-columns: 360px 1fr; height: calc(100vh - 52px); }
    .panel { border-right: 1px solid #24304a; padding: 14px; overflow: auto; }
    .main { padding: 14px; overflow: auto; }

    .card { background: #111a2e; border: 1px solid #24304a; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    label { font-size: 13px; opacity: .9; }
    input[type="file"], select, button { font-size: 13px; }
    button { background: #2b66ff; border: 0; color: white; padding: 8px 10px; border-radius: 10px; cursor: pointer; }
    button.secondary { background: #24304a; }
    button.danger { background: #e5484d; }
    button:disabled { opacity: .5; cursor: not-allowed; }

    .small { font-size: 12px; opacity: .85; }
    .list { max-height: 210px; overflow: auto; border-radius: 10px; border: 1px solid #24304a; }
    .list table { width:100%; border-collapse: collapse; }
    .list th, .list td { padding: 8px; border-bottom: 1px solid #24304a; font-size: 12px; }
    .list tr.selected { background: rgba(43,102,255,.18); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; padding: 2px 6px; border: 1px solid #24304a; border-radius: 8px; background:#0b1220; }

    input[type="number"] { background:#0b1220; color:#e8eefc; border:1px solid #24304a; border-radius:10px; padding:8px; }
    /*number inputs readable in dark mode*/

    canvas { background: #050814; border: 1px solid #24304a; border-radius: 12px; max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <header>
    <h1>YOLO Folder Annotation Tool</h1>
    <div class="muted">Load an <b>image folder</b> + <b>label folder</b> (YOLO txt). Draw/edit boxes. Export YOLO.</div>
  </header>

  <div class="wrap">
    <div class="panel">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div>
            <div><b>1) Load folders</b></div>
            <div class="small">Images + Labels must share the same basename (e.g. <span class="kbd">abc.jpg</span> ↔ <span class="kbd">abc.txt</span>).</div>
            <div style="height:10px"></div>
            <div class="row">
              <button id="pickSaveFolderBtn" class="secondary">Pick label save folder (Chrome/Edge)</button>
              <span class="small" id="saveFolderText">No save folder selected</span>
            </div>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div style="flex:1; min-width: 240px;">
            <label>Image folder</label><br/>
            <input id="imagesInput" type="file" webkitdirectory directory multiple />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <div style="flex:1; min-width: 240px;">
            <label>Label folder (YOLO .txt)</label><br/>
            <input id="labelsInput" type="file" webkitdirectory directory multiple />
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="row">
          <button id="buildIndexBtn" class="secondary">Build index</button>
          <span class="small" id="statusText">Waiting…</span>
        </div>
      </div>

      <div class="card">
        <div><b>2) Select image</b></div>
        <div style="height:8px"></div>
        <select id="imageSelect" style="width:100%;" disabled></select>
        <div style="height:10px"></div>
        <div class="row">
          <button id="prevBtn" class="secondary" disabled>Prev</button>
          <button id="nextBtn" class="secondary" disabled>Next</button>
        </div>
      </div>

      <div class="card">
        <div><b>3) Box tools</b></div>
        <div class="small">Drag to draw a box. Click a row to select. Delete removes selected.</div>
        <div style="height:10px"></div>
        <div class="row">
          <div style="flex:1; min-width:110px;">
            <label>xc</label><br/>
            <input id="editXc" type="number" step="0.0001" min="0" max="1" style="width:100%;" />
          </div>
          <div style="flex:1; min-width:110px;">
            <label>yc</label><br/>
            <input id="editYc" type="number" step="0.0001" min="0" max="1" style="width:100%;" />
          </div>
        </div>
        
        <div style="height:8px"></div>
        <div class="row">
          <div style="flex:1; min-width:110px;">
            <label>w</label><br/>
            <input id="editW" type="number" step="0.0001" min="0" max="1" style="width:100%;" />
          </div>
          <div style="flex:1; min-width:110px;">
            <label>h</label><br/>
            <input id="editH" type="number" step="0.0001" min="0" max="1" style="width:100%;" />
          </div>
        </div>
        
        <div style="height:10px"></div>
        <div class="row">
          <button id="applyEditBtn" class="secondary" disabled>Apply changes</button>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <div style="flex:1; min-width:240px;">
            <label>Class</label><br/>
            <select id="classSelect" style="width:100%;"></select>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <button id="deleteBtn" class="danger" disabled>Delete selected</button>
          <button id="clearBtn" class="secondary" disabled>Clear all</button>
        </div>
        
        <div style="height:10px"></div>
        <div class="row">
          <button id="downloadBtn" disabled>Save YOLO (.txt)</button>
        </div>
      </div>

      <div class="card">
        <div><b>Shortcuts</b></div>
        <div class="small">
          <div><span class="kbd">←</span>/<span class="kbd">→</span> prev/next image</div>
          <div><span class="kbd">Del</span> delete selected box</div>
        </div>
      </div>

      <div class="card">
        <div><b>YOLO classes</b></div>
        <div class="small" id="classLegend"></div>
      </div>
    </div>

    <div class="main">
      <div class="card">
        <div class="row" style="justify-content:space-between;">
          <div><b>Canvas</b> <span class="small">(boxes are stored as YOLO normalised coords)</span></div>
          <div class="small" id="imgMeta"></div>
        </div>
        <div style="height:10px"></div>
        <canvas id="canvas" width="960" height="540"></canvas>
        <div class="small" style="margin-top:10px;">
          Tip: if your boxes look “off”, your labels might not match the image size used during labelling.
        </div>
      </div>

      <div class="card">
        <div><b>Boxes (current image)</b></div>
        <div style="height:8px"></div>
        <div class="list">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Class</th>
                <th>x</th><th>y</th><th>w</th><th>h</th>
              </tr>
            </thead>
            <tbody id="boxesTbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG (edit this only)
 *  ========================= */
const YOLO_CLASSES = [
  "class0_emergencyVehicle",
  "class1_lightVehicle",
  "class2_mediumVehicle",
  "class3_heavyVehicle",
  "class4_taxi",
  "class5_bus",
  "class_motocycle",
  "singleWheel",
  "doubleWheel",
  "license_plate",
  "license_plate_taxi"
];

/** =========================
 *  STATE
 *  ========================= */
const state = {
  images: [],            // File[]
  labels: [],            // File[]
  labelMap: new Map(),   // basename -> File
  imageMap: new Map(),   // basename -> File
  basenames: [],         // sorted basenames
  idx: -1,

  imgEl: new Image(),
  imgW: 0,
  imgH: 0,

  // boxes in YOLO normalised format: {cls, xc, yc, w, h}
  boxes: [],
  selected: -1,

  // drawing
  isDrawing: false,
  startPx: {x:0, y:0},
  currPx:  {x:0, y:0},
  saveDirHandle: null,    // Folder handle for writing (File System Access API)
};

/** =========================
 *  DOM
 *  ========================= */
const imagesInput = document.getElementById('imagesInput');
const labelsInput = document.getElementById('labelsInput');
const buildIndexBtn = document.getElementById('buildIndexBtn');
const statusText = document.getElementById('statusText');

const imageSelect = document.getElementById('imageSelect');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');

const classSelect = document.getElementById('classSelect');
const classLegend = document.getElementById('classLegend');

const deleteBtn = document.getElementById('deleteBtn');
const clearBtn = document.getElementById('clearBtn');
const downloadBtn = document.getElementById('downloadBtn');

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const boxesTbody = document.getElementById('boxesTbody');
const imgMeta = document.getElementById('imgMeta');

// addition
const editXc = document.getElementById('editXc');
const editYc = document.getElementById('editYc');
const editW  = document.getElementById('editW');
const editH  = document.getElementById('editH');
const applyEditBtn = document.getElementById('applyEditBtn');

// addition 02
const pickSaveFolderBtn = document.getElementById('pickSaveFolderBtn');
const saveFolderText = document.getElementById('saveFolderText');

/** =========================
 *  HELPERS
 *  ========================= */
function basenameOf(fileName) {
  // "a/b/c.jpg" -> "c"
  const base = fileName.split('/').pop();
  const dot = base.lastIndexOf('.');
  return dot >= 0 ? base.slice(0, dot) : base;
}
function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
function fmt(n) { return Number(n).toFixed(4); }

function pxToYoloRect(x1, y1, x2, y2) {
  const left = Math.min(x1, x2), right = Math.max(x1, x2);
  const top = Math.min(y1, y2), bottom = Math.max(y1, y2);

  const w = right - left;
  const h = bottom - top;

  // normalise
  const xc = (left + w/2) / state.imgW;
  const yc = (top + h/2) / state.imgH;
  const wn = w / state.imgW;
  const hn = h / state.imgH;

  return {
    xc: clamp(xc, 0, 1),
    yc: clamp(yc, 0, 1),
    w: clamp(wn, 0, 1),
    h: clamp(hn, 0, 1)
  };
}

function yoloToPxRect(box) {
  const w = box.w * state.imgW;
  const h = box.h * state.imgH;
  const x = (box.xc * state.imgW) - w/2;
  const y = (box.yc * state.imgH) - h/2;
  return {x, y, w, h};
}

function parseYoloTxt(txt) {
  const boxes = [];
  const lines = txt.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
  for (const line of lines) {
    const parts = line.split(/\s+/);
    if (parts.length < 5) continue;
    const cls = Number(parts[0]);
    const xc = Number(parts[1]);
    const yc = Number(parts[2]);
    const w  = Number(parts[3]);
    const h  = Number(parts[4]);
    if ([cls, xc, yc, w, h].some(v => Number.isNaN(v))) continue;
    boxes.push({ cls, xc, yc, w, h });
  }
  return boxes;
}

function toYoloTxt(boxes) {
  return boxes
    .map(b => `${b.cls} ${fmt(b.xc)} ${fmt(b.yc)} ${fmt(b.w)} ${fmt(b.h)}`)
    .join('\n') + '\n';
}

async function readTextFile(file) {
  return await file.text();
}

function downloadText(filename, text) {
  const blob = new Blob([text], {type: 'text/plain'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(() => {
    URL.revokeObjectURL(a.href);
    a.remove();
  }, 0);
}

/* Implement folder picking + permission */
async function supportsFileSystemAccess() {
  return 'showDirectoryPicker' in window;
}

pickSaveFolderBtn.addEventListener('click', async () => {
  try {
    if (!(await supportsFileSystemAccess())) {
      alert("Your browser doesn't support saving to a folder.\nUse Chrome or Edge on desktop.");
      return;
    }

    // user chooses the folder where label .txt files live
    const handle = await window.showDirectoryPicker({ mode: 'readwrite' });
    state.saveDirHandle = handle;
    saveFolderText.textContent = "Save folder selected ✅";
    statusText.textContent = "✅ Save folder selected. 'Save YOLO' will overwrite txt in that folder.";
  } catch (err) {
    console.error(err);
    statusText.textContent = "Save folder not selected.";
  }
});


/** =========================
 *  UI INIT
 *  ========================= */
function initClassUI() {
  // class dropdown
  classSelect.innerHTML = '';
  YOLO_CLASSES.forEach((name, i) => {
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = `${i}: ${name}`;
    classSelect.appendChild(opt);
  });

  classLegend.innerHTML = YOLO_CLASSES
    .map((c, i) => `${i}: ${c}`)
    .join('<br/>');
}
initClassUI();

/** =========================
 *  BUILD INDEX
 *  ========================= */
buildIndexBtn.addEventListener('click', () => {
  state.images = Array.from(imagesInput.files || []);
  state.labels = Array.from(labelsInput.files || []);

  state.imageMap.clear();
  state.labelMap.clear();

  for (const f of state.images) state.imageMap.set(basenameOf(f.webkitRelativePath || f.name), f);
  for (const f of state.labels) state.labelMap.set(basenameOf(f.webkitRelativePath || f.name), f);

  // only show images
  state.basenames = Array.from(state.imageMap.keys()).sort((a,b)=>a.localeCompare(b));

  imageSelect.innerHTML = '';
  state.basenames.forEach((bn, idx) => {
    const opt = document.createElement('option');
    opt.value = String(idx);
    const hasLabel = state.labelMap.has(bn) ? '✓' : '—';
    opt.textContent = `${idx+1}. ${bn}  [label: ${hasLabel}]`;
    imageSelect.appendChild(opt);
  });

  const ok = state.basenames.length > 0;
  imageSelect.disabled = !ok;
  prevBtn.disabled = !ok;
  nextBtn.disabled = !ok;

  statusText.textContent =
    ok ? `Indexed ${state.basenames.length} images, ${state.labels.length} label files.` : 'No images selected.';

  if (ok) {
    state.idx = 0;
    imageSelect.value = '0';
    loadCurrent();
  }
});

/** =========================
 *  LOAD CURRENT IMAGE + LABELS
 *  ========================= */
imageSelect.addEventListener('change', () => {
  state.idx = Number(imageSelect.value);
  loadCurrent();
});
prevBtn.addEventListener('click', () => { if (state.idx > 0) { state.idx--; imageSelect.value = String(state.idx); loadCurrent(); } });
nextBtn.addEventListener('click', () => { if (state.idx < state.basenames.length-1) { state.idx++; imageSelect.value = String(state.idx); loadCurrent(); } });

async function loadCurrent() {
  const bn = state.basenames[state.idx];
  const imgFile = state.imageMap.get(bn);
  const lblFile = state.labelMap.get(bn);

  // load image
  const imgUrl = URL.createObjectURL(imgFile);
  await new Promise((resolve, reject) => {
    state.imgEl.onload = () => resolve();
    state.imgEl.onerror = () => reject(new Error('Failed to load image'));
    state.imgEl.src = imgUrl;
  });
  state.imgW = state.imgEl.naturalWidth;
  state.imgH = state.imgEl.naturalHeight;
  imgMeta.textContent = `${imgFile.name} — ${state.imgW}×${state.imgH}`;

  // canvas resize keeping aspect
  const maxW = 1200;
  const scale = Math.min(1, maxW / state.imgW);
  canvas.width = Math.round(state.imgW * scale);
  canvas.height = Math.round(state.imgH * scale);

  // load labels (if exist)
  state.boxes = [];
  if (lblFile) {
    const txt = await readTextFile(lblFile);
    state.boxes = parseYoloTxt(txt);
    statusText.textContent = `Loaded labels: ${lblFile.name} (${state.boxes.length} boxes)`;
  } else {
    statusText.textContent = `No label file for ${bn}. You can draw new boxes.`;
  }

  state.selected = -1;
  updateButtons();
  render();
  renderBoxTable();

  URL.revokeObjectURL(imgUrl);
}

/** =========================
 *  RENDERING
 *  ========================= */
function render() {
  // clear
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // draw image scaled
  const sx = canvas.width / state.imgW;
  const sy = canvas.height / state.imgH;

  ctx.drawImage(state.imgEl, 0, 0, canvas.width, canvas.height);

  // draw existing boxes
  state.boxes.forEach((b, i) => {
    const r = yoloToPxRect(b);
    const x = r.x * sx, y = r.y * sy, w = r.w * sx, h = r.h * sy;

    ctx.lineWidth = (i === state.selected) ? 3 : 2;
    ctx.strokeStyle = (i === state.selected) ? '#2b66ff' : '#8fb0ff';
    ctx.strokeRect(x, y, w, h);

    // label tag
    ctx.fillStyle = 'rgba(11,18,32,.85)';
    ctx.fillRect(x, Math.max(0, y-18), 220, 18);
    ctx.fillStyle = '#e8eefc';
    const name = YOLO_CLASSES[b.cls] || `class_${b.cls}`;
    ctx.font = '12px system-ui';
    ctx.fillText(`${i+1}. ${b.cls}: ${name}`, x+6, Math.max(12, y-6));
  });

  // draw in-progress box
  if (state.isDrawing) {
    const x1 = state.startPx.x, y1 = state.startPx.y;
    const x2 = state.currPx.x, y2 = state.currPx.y;
    const left = Math.min(x1,x2), top = Math.min(y1,y2);
    const w = Math.abs(x2-x1), h = Math.abs(y2-y1);
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#e8eefc';
    ctx.setLineDash([6,4]);
    ctx.strokeRect(left, top, w, h);
    ctx.setLineDash([]);
  }
}

function renderBoxTable() {
  boxesTbody.innerHTML = '';
  state.boxes.forEach((b, i) => {
    const tr = document.createElement('tr');
    if (i === state.selected) tr.classList.add('selected');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${b.cls}: ${YOLO_CLASSES[b.cls] || 'unknown'}</td>
      <td>${fmt(b.xc)}</td>
      <td>${fmt(b.yc)}</td>
      <td>${fmt(b.w)}</td>
      <td>${fmt(b.h)}</td>
    `;
    tr.addEventListener('click', () => {
      state.selected = i;
      const b = state.boxes[i];
      // addition
      classSelect.value = String(b.cls);
      editXc.value = b.xc;
      editYc.value = b.yc;
      editW.value  = b.w;
      editH.value  = b.h;
      applyEditBtn.disabled = false;

      updateButtons();
      render();
      renderBoxTable();
    });
    boxesTbody.appendChild(tr);
  });
}

/** =========================
 *  CANVAS INTERACTION
 *  ========================= */
function canvasToImagePx(evt) {
  const rect = canvas.getBoundingClientRect();
  const x = (evt.clientX - rect.left);
  const y = (evt.clientY - rect.top);
  // convert to original image pixels
  const imgX = x * (state.imgW / canvas.width);
  const imgY = y * (state.imgH / canvas.height);
  return { imgX, imgY, canvasX: x, canvasY: y };
}

canvas.addEventListener('mousedown', (evt) => {
  if (!state.imgW) return;

  const {canvasX, canvasY} = canvasToImagePx(evt);
  state.isDrawing = true;
  state.startPx = {x: canvasX, y: canvasY};
  state.currPx = {x: canvasX, y: canvasY};
  render();
});

canvas.addEventListener('mousemove', (evt) => {
  if (!state.isDrawing) return;
  const {canvasX, canvasY} = canvasToImagePx(evt);
  state.currPx = {x: canvasX, y: canvasY};
  render();
});

canvas.addEventListener('mouseup', (evt) => {
  if (!state.isDrawing) return;
  state.isDrawing = false;

  const rect = canvas.getBoundingClientRect();
  const endX = (evt.clientX - rect.left);
  const endY = (evt.clientY - rect.top);

  // convert canvas coords -> image px
  const x1_img = state.startPx.x * (state.imgW / canvas.width);
  const y1_img = state.startPx.y * (state.imgH / canvas.height);
  const x2_img = endX * (state.imgW / canvas.width);
  const y2_img = endY * (state.imgH / canvas.height);

  // ignore tiny boxes
  if (Math.abs(x2_img - x1_img) < 4 || Math.abs(y2_img - y1_img) < 4) {
    render();
    return;
  }

  const cls = Number(classSelect.value);
  const yolo = pxToYoloRect(x1_img, y1_img, x2_img, y2_img);
  state.boxes.push({ cls, ...yolo });

  state.selected = state.boxes.length - 1;
  updateButtons();
  render();
  renderBoxTable();
});

function updateButtons() {
  const has = state.boxes.length > 0;
  deleteBtn.disabled = !(state.selected >= 0);
  clearBtn.disabled = !has;
  downloadBtn.disabled = !state.imgW;
  applyEditBtn.disabled = !(state.selected >= 0);
}
updateButtons();

/** =========================
 *  ACTIONS
 *  ========================= */
deleteBtn.addEventListener('click', () => {
  if (state.selected < 0) return;
  state.boxes.splice(state.selected, 1);
  state.selected = -1;
  updateButtons();
  render();
  renderBoxTable();
});

clearBtn.addEventListener('click', () => {
  state.boxes = [];
  state.selected = -1;
  updateButtons();
  render();
  renderBoxTable();
});

downloadBtn.addEventListener('click', async () => {
  if (state.idx < 0) return;
  const bn = state.basenames[state.idx];
  const txt = toYoloTxt(state.boxes);

  // If we have a save folder handle, try to overwrite in that folder
  if (state.saveDirHandle) {
    try {
      const fileHandle = await state.saveDirHandle.getFileHandle(`${bn}.txt`, { create: true });
      const writable = await fileHandle.createWritable();
      await writable.write(txt);
      await writable.close();
      statusText.textContent = `✅ Saved to folder: ${bn}.txt`;
      return;
    } catch (err) {
      console.error(err);
      statusText.textContent = `⚠️ Could not write to folder. Downloading instead...`;
      // fallback to download
    }
  }

  // Fallback (always works)
  downloadText(`${bn}.txt`, txt);
  statusText.textContent = `⬇️ Downloaded: ${bn}.txt (replace it in your label folder)`;
});

//addition
applyEditBtn.addEventListener('click', () => {
  if (state.selected < 0) return;

  const cls = Number(classSelect.value);
  const xc = Number(editXc.value);
  const yc = Number(editYc.value);
  const w  = Number(editW.value);
  const h  = Number(editH.value);

  if ([cls, xc, yc, w, h].some(v => Number.isNaN(v))) return;

  state.boxes[state.selected] = {
    cls,
    xc: clamp(xc, 0, 1),
    yc: clamp(yc, 0, 1),
    w:  clamp(w, 0, 1),
    h:  clamp(h, 0, 1)
  };

  render();
  renderBoxTable();
});


/** =========================
 *  KEYBOARD SHORTCUTS
 *  ========================= */
window.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowLeft') prevBtn.click();
  if (e.key === 'ArrowRight') nextBtn.click();
  if (e.key === 'Delete') deleteBtn.click();
});
</script>
</body>
</html>


